<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blipss Admin Dashboard - Comprehensive Management</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA3ctp1Waczjq5VJZp-rO0I1eRa916I_8s&libraries=places"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #FF6B9D 0%, #FFA06B 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .search-bar {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }

        .search-bar input {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #E0E0E0;
            border-radius: 8px;
            font-size: 16px;
        }

        .search-bar input:focus {
            outline: none;
            border-color: #FF6B9D;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .tab {
            padding: 12px 24px;
            background: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .tab.active {
            background: #FF6B9D;
            color: white;
        }

        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f9f9f9;
            font-weight: 600;
        }

        .clickable-username {
            color: #FF6B9D;
            cursor: pointer;
            font-weight: 600;
            text-decoration: underline;
        }

        .clickable-username:hover {
            color: #FFA06B;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 5px;
            transition: all 0.2s;
        }

        .btn-primary { background: #FF6B9D; color: white; }
        .btn-success { background: #4CAF50; color: white; }
        .btn-warning { background: #FFA500; color: white; }
        .btn-danger { background: #FF4444; color: white; }
        .btn-info { background: #4A90E2; color: white; }
        .btn-secondary { background: #999; color: white; }

        .btn:hover {
            transform: scale(1.05);
            opacity: 0.9;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            margin: 20px;
        }

        .modal-content h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .user-detail-header {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #FF6B9D 0%, #FFA06B 100%);
            border-radius: 12px;
            color: white;
            margin-bottom: 30px;
        }

        .user-detail-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid white;
        }

        .user-detail-info h2 {
            margin-bottom: 5px;
            color: white;
        }

        .user-detail-info p {
            opacity: 0.9;
        }

        .user-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .user-stat {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .user-stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #FF6B9D;
        }

        .user-stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .action-section {
            margin-bottom: 30px;
        }

        .action-section h3 {
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #FF6B9D;
            padding-bottom: 10px;
        }

        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .action-grid .btn {
            width: 100%;
            margin: 0;
        }

        .history-item {
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #FF6B9D;
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .history-item-action {
            font-weight: 600;
            color: #333;
        }

        .history-item-date {
            color: #999;
            font-size: 12px;
        }

        .history-item-details {
            color: #666;
            font-size: 14px;
        }

        .blip-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .blip-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
        }

        .blip-item img, .blip-item video {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .blip-item-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.7));
            color: white;
            padding: 10px;
            font-size: 12px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .stat-card h3 {
            color: #999;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stat-card .number {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }

        .login-form {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        .login-form h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #FF6B9D;
        }

        #app.logged-out .dashboard {
            display: none;
        }

        #app.logged-in .login-form {
            display: none;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-banned {
            background: #FF4444;
            color: white;
        }

        .badge-admin {
            background: #FFD700;
            color: #333;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #999;
        }
    </style>
</head>
<body>
    <div id="app" class="logged-out">
        <!-- Login Form -->
        <div class="login-form">
            <h1>🎬 Blipss Admin</h1>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="loginEmail" placeholder="admin@blipss.com">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="loginPassword" placeholder="••••••••">
            </div>
            <button class="btn btn-primary" onclick="login()" style="width: 100%; margin-top: 10px;">Login</button>
        </div>

        <!-- Dashboard -->
        <div class="dashboard">
            <div class="container">
                <div class="header" style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h1>🎬 Blipss Admin Dashboard</h1>
                        <p>Comprehensive user and content management</p>
                    </div>
                    <button class="btn btn-danger" onclick="logout()" style="margin: 0;">Logout</button>
                </div>

                <!-- Search Bar -->
                <div class="search-bar">
                    <input type="text" id="userSearch" placeholder="🔍 Search users by username, email, or ID..." onkeyup="searchUsers()">
                    <button class="btn btn-primary" onclick="searchUsers()">Search</button>
                    <button class="btn btn-secondary" onclick="clearSearch()">Clear</button>
                </div>

                <div class="stats">
                    <div class="stat-card">
                        <h3>Total Users</h3>
                        <div class="number" id="totalUsers">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Blips</h3>
                        <div class="number" id="totalBlips">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Banned Users</h3>
                        <div class="number" id="bannedUsers">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Pending Reports</h3>
                        <div class="number" id="pendingReports">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Pending Verifications</h3>
                        <div class="number" id="pendingVerifications">-</div>
                    </div>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="showTab('users')">Users</button>
                    <button class="tab" onclick="showTab('blips')">Blips</button>
                    <button class="tab" onclick="showTab('reports')">Reports</button>
                    <button class="tab" onclick="showTab('appeals')">Appeals</button>
                    <button class="tab" onclick="showTab('verifications')">Verifications</button>
                    <button class="tab" onclick="showTab('admin-drops')">Admin Drops</button>
                </div>

                <div class="content">
                    <!-- Users Tab -->
                    <div id="users-tab" class="tab-content active">
                        <h2 style="margin-bottom: 20px;">User Management</h2>
                        <div id="usersTable"></div>
                    </div>

                    <!-- Blips Tab -->
                    <div id="blips-tab" class="tab-content">
                        <h2 style="margin-bottom: 20px;">Blip Management</h2>
                        <p style="color: #666; margin-bottom: 20px;">Search for a user to view and manage their blips</p>

                        <div class="search-bar" style="margin-bottom: 30px;">
                            <input type="text" id="blipUserSearch" placeholder="🔍 Search users by username, email, or ID..." onkeyup="searchUsersForBlips()">
                            <button class="btn btn-primary" onclick="searchUsersForBlips()">Search</button>
                            <button class="btn btn-secondary" onclick="clearBlipUserSearch()">Clear</button>
                        </div>

                        <div id="blipsSearchResults"></div>
                    </div>

                    <!-- Reports Tab -->
                    <div id="reports-tab" class="tab-content">
                        <h2 style="margin-bottom: 20px;">Reported Content</h2>

                        <!-- Filter and Search -->
                        <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                            <div style="display: flex; gap: 10px;">
                                <button id="filterReportsPending" class="btn btn-primary" onclick="setReportFilter('pending')">
                                    Pending
                                </button>
                                <button id="filterReportsResolved" class="btn btn-secondary" onclick="setReportFilter('resolved')">
                                    Resolved
                                </button>
                                <button id="filterReportsAll" class="btn btn-secondary" onclick="setReportFilter('all')">
                                    All Reports
                                </button>
                            </div>
                            <div style="flex: 1; display: flex; gap: 10px;">
                                <input
                                    type="text"
                                    id="reportSearch"
                                    placeholder="🔍 Search by username..."
                                    style="flex: 1; padding: 10px 15px; border: 2px solid #E0E0E0; border-radius: 8px; font-size: 14px;"
                                    onkeyup="filterReports()"
                                >
                                <button class="btn btn-secondary" onclick="clearReportSearch()">Clear</button>
                            </div>
                        </div>

                        <div id="reportsTable"></div>
                    </div>

                    <!-- Appeals Tab -->
                    <div id="appeals-tab" class="tab-content">
                        <h2 style="margin-bottom: 20px;">Ban Appeals</h2>

                        <!-- Filter and Search -->
                        <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                            <div style="display: flex; gap: 10px;">
                                <button id="filterUnresolved" class="btn btn-primary" onclick="setAppealFilter('unresolved')">
                                    Not Yet Resolved
                                </button>
                                <button id="filterResolved" class="btn btn-secondary" onclick="setAppealFilter('resolved')">
                                    Resolved
                                </button>
                                <button id="filterAll" class="btn btn-secondary" onclick="setAppealFilter('all')">
                                    All Appeals
                                </button>
                            </div>
                            <div style="flex: 1; display: flex; gap: 10px;">
                                <input
                                    type="text"
                                    id="appealSearch"
                                    placeholder="🔍 Search by username or email..."
                                    style="flex: 1; padding: 10px 15px; border: 2px solid #E0E0E0; border-radius: 8px; font-size: 14px;"
                                    onkeyup="filterAppeals()"
                                >
                                <button class="btn btn-secondary" onclick="clearAppealSearch()">Clear</button>
                            </div>
                        </div>

                        <div id="appealsTable"></div>
                    </div>

                    <!-- Verifications Tab -->
                    <div id="verifications-tab" class="tab-content">
                        <h2 style="margin-bottom: 20px;">Verification Requests</h2>

                        <!-- Filter -->
                        <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                            <div style="display: flex; gap: 10px;">
                                <button id="filterVerificationsPending" class="btn btn-primary" onclick="setVerificationFilter('pending')">
                                    Pending
                                </button>
                                <button id="filterVerificationsApproved" class="btn btn-secondary" onclick="setVerificationFilter('approved')">
                                    Approved
                                </button>
                                <button id="filterVerificationsRejected" class="btn btn-secondary" onclick="setVerificationFilter('rejected')">
                                    Rejected
                                </button>
                                <button id="filterVerificationsAll" class="btn btn-secondary" onclick="setVerificationFilter('all')">
                                    All Requests
                                </button>
                            </div>
                        </div>

                        <div id="verificationsTable"></div>
                    </div>

                    <!-- Admin Drops Tab -->
                    <div id="admin-drops-tab" class="tab-content">
                        <h2 style="margin-bottom: 20px;">Admin Drops Management</h2>

                        <!-- Place New Drop Section -->
                        <div style="background: linear-gradient(135deg, #FF6B9D 0%, #FFA06B 100%); padding: 25px; border-radius: 12px; margin-bottom: 30px; color: white;">
                            <h3 style="margin-bottom: 20px; font-size: 20px;">Place New Drop</h3>

                            <!-- Address Search -->
                            <div style="margin-bottom: 15px;">
                                <input type="text" id="addressSearch" placeholder="🔍 Search for an address..." style="width: 100%; padding: 15px; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; font-size: 15px; background: rgba(255,255,255,0.95); color: #333;">
                            </div>

                            <!-- Map Container -->
                            <div id="dropMap" style="width: 100%; height: 450px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);"></div>

                            <!-- Drop Form -->
                            <div style="background: rgba(255,255,255,0.95); padding: 25px; border-radius: 8px; color: #333;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #FF6B9D;">Title *</label>
                                        <input type="text" id="dropTitle" placeholder="Enter drop title" style="width: 100%; padding: 12px; border: 2px solid #E0E0E0; border-radius: 6px; font-size: 14px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #FF6B9D;">Drop Type *</label>
                                        <select id="dropType" style="width: 100%; padding: 12px; border: 2px solid #E0E0E0; border-radius: 6px; font-size: 14px;">
                                            <option value="test">Test</option>
                                            <option value="reward">Reward</option>
                                            <option value="special">Special</option>
                                        </select>
                                    </div>
                                </div>

                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #FF6B9D;">Description</label>
                                    <textarea id="dropDescription" placeholder="Enter drop description" rows="3" style="width: 100%; padding: 12px; border: 2px solid #E0E0E0; border-radius: 6px; font-size: 14px; resize: vertical;"></textarea>
                                </div>

                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #FF6B9D;">📹 Drop Media (optional)</label>
                                    <input type="file" id="dropMedia" accept="video/*,image/*" style="width: 100%; padding: 12px; border: 2px solid #E0E0E0; border-radius: 6px; font-size: 14px; background: white;">
                                    <div id="mediaUploadProgress" style="display: none; margin-top: 10px; padding: 10px; background: #E3F2FD; border-radius: 6px; color: #1976D2; font-size: 13px;"></div>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #FF6B9D;">Icon Type *</label>
                                        <select id="dropIconType" style="width: 100%; padding: 12px; border: 2px solid #E0E0E0; border-radius: 6px; font-size: 14px;">
                                            <option value="coin">Coin</option>
                                            <option value="star">Star</option>
                                            <option value="gift">Gift</option>
                                            <option value="trophy">Trophy</option>
                                            <option value="location">Location</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #FF6B9D;">Reward Amount *</label>
                                        <input type="number" id="dropRewardAmount" value="10" min="0" style="width: 100%; padding: 12px; border: 2px solid #E0E0E0; border-radius: 6px; font-size: 14px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #FF6B9D;">Radius (feet) *</label>
                                        <input type="number" id="dropRadius" value="100" min="1" style="width: 100%; padding: 12px; border: 2px solid #E0E0E0; border-radius: 6px; font-size: 14px;">
                                    </div>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #FF6B9D;">View Limit (optional)</label>
                                        <input type="number" id="dropViewLimit" placeholder="Leave empty for unlimited" min="1" style="width: 100%; padding: 12px; border: 2px solid #E0E0E0; border-radius: 6px; font-size: 14px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #FF6B9D;">Expires At (optional)</label>
                                        <input type="datetime-local" id="dropExpiresAt" style="width: 100%; padding: 12px; border: 2px solid #E0E0E0; border-radius: 6px; font-size: 14px;">
                                    </div>
                                </div>

                                <!-- Notification Settings -->
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #FF6B9D;">📬 Notification Message (optional)</label>
                                    <div style="position: relative;">
                                        <textarea id="dropNotificationMessage" placeholder="Enter notification message to send to users within the notification radius" rows="3" style="width: 100%; padding: 12px 50px 12px 12px; border: 2px solid #E0E0E0; border-radius: 6px; font-size: 14px; resize: vertical;"></textarea>
                                        <button type="button" onclick="openEmojiPicker()" style="position: absolute; right: 10px; top: 10px; background: #FFF3E0; border: 2px solid #FFB74D; border-radius: 6px; padding: 8px 12px; cursor: pointer; font-size: 18px; line-height: 1;">😀</button>
                                    </div>
                                    <div id="emojiPicker" style="display: none; position: absolute; background: white; border: 2px solid #E0E0E0; border-radius: 8px; padding: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000; max-width: 300px; max-height: 200px; overflow-y: auto;">
                                        <div style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 5px;">
                                            <button type="button" onclick="insertEmoji('😀')" style="font-size: 20px; padding: 5px; border: none; background: none; cursor: pointer;">😀</button>
                                            <button type="button" onclick="insertEmoji('😃')" style="font-size: 20px; padding: 5px; border: none; background: none; cursor: pointer;">😃</button>
                                            <button type="button" onclick="insertEmoji('😄')" style="font-size: 20px; padding: 5px; border: none; background: none; cursor: pointer;">😄</button>
                                            <button type="button" onclick="insertEmoji('😁')" style="font-size: 20px; padding: 5px; border: none; background: none; cursor: pointer;">😁</button>
                                            <button type="button" onclick="insertEmoji('🎉')" style="font-size: 20px; padding: 5px; border: none; background: none; cursor: pointer;">🎉</button>
                                            <button type="button" onclick="insertEmoji('🎊')" style="font-size: 20px; padding: 5px; border: none; background: none; cursor: pointer;">🎊</button>
                                            <button type="button" onclick="insertEmoji('🎁')" style="font-size: 20px; padding: 5px; border: none; background: none; cursor: pointer;">🎁</button>
                                            <button type="button" onclick="insertEmoji('🏆')" style="font-size: 20px; padding: 5px; border: none; background: none; cursor: pointer;">🏆</button>
                                            <button type="button" onclick="insertEmoji('⭐')" style="font-size: 20px; padding: 5px; border: none; background: none; cursor: pointer;">⭐</button>
                                            <button type="button" onclick="insertEmoji('✨')" style="font-size: 20px; padding: 5px; border: none; background: none; cursor: pointer;">✨</button>
                                            <button type="button" onclick="insertEmoji('💎')" style="font-size: 20px; padding: 5px; border: none; background: none; cursor: pointer;">💎</button>
                                            <button type="button" onclick="insertEmoji('💰')" style="font-size: 20px; padding: 5px; border: none; background: none; cursor: pointer;">💰</button>
                                            <button type="button" onclick="insertEmoji('🔥')" style="font-size: 20px; padding: 5px; border: none; background: none; cursor: pointer;">🔥</button>
                                            <button type="button" onclick="insertEmoji('💥')" style="font-size: 20px; padding: 5px; border: none; background: none; cursor: pointer;">💥</button>
                                            <button type="button" onclick="insertEmoji('💝')" style="font-size: 20px; padding: 5px; border: none; background: none; cursor: pointer;">💝</button>
                                            <button type="button" onclick="insertEmoji('❤️')" style="font-size: 20px; padding: 5px; border: none; background: none; cursor: pointer;">❤️</button>
                                            <button type="button" onclick="insertEmoji('🌟')" style="font-size: 20px; padding: 5px; border: none; background: none; cursor: pointer;">🌟</button>
                                            <button type="button" onclick="insertEmoji('🎯')" style="font-size: 20px; padding: 5px; border: none; background: none; cursor: pointer;">🎯</button>
                                            <button type="button" onclick="insertEmoji('🚀')" style="font-size: 20px; padding: 5px; border: none; background: none; cursor: pointer;">🚀</button>
                                            <button type="button" onclick="insertEmoji('🌈')" style="font-size: 20px; padding: 5px; border: none; background: none; cursor: pointer;">🌈</button>
                                            <button type="button" onclick="insertEmoji('🎈')" style="font-size: 20px; padding: 5px; border: none; background: none; cursor: pointer;">🎈</button>
                                            <button type="button" onclick="insertEmoji('🍀')" style="font-size: 20px; padding: 5px; border: none; background: none; cursor: pointer;">🍀</button>
                                            <button type="button" onclick="insertEmoji('🌺')" style="font-size: 20px; padding: 5px; border: none; background: none; cursor: pointer;">🌺</button>
                                            <button type="button" onclick="insertEmoji('🌸')" style="font-size: 20px; padding: 5px; border: none; background: none; cursor: pointer;">🌸</button>
                                        </div>
                                    </div>
                                </div>

                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #FF6B9D;">📍 Notification Radius (miles) *</label>
                                    <input type="number" id="dropNotificationRadius" value="5.0" min="0.1" max="100" step="0.1" style="width: 100%; padding: 12px; border: 2px solid #E0E0E0; border-radius: 6px; font-size: 14px;">
                                    <small style="display: block; margin-top: 5px; color: #666;">Users within this radius will receive a notification (0.1 to 100 miles)</small>
                                </div>

                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div id="dropLocationInfo" style="color: #666; font-size: 14px;">
                                        Click on the map to set drop location
                                    </div>
                                    <button class="btn btn-primary" onclick="createAdminDrop()" style="padding: 12px 30px; font-size: 16px; font-weight: 600;">
                                        Create Drop
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Manage Drops Section -->
                        <div style="background: white; padding: 25px; border-radius: 12px; border: 2px solid #E0E0E0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="font-size: 20px; color: #333;">Manage Drops</h3>
                                <button class="btn btn-info" onclick="loadAdminDrops()" style="padding: 10px 20px;">
                                    Refresh List
                                </button>
                            </div>

                            <div id="adminDropsList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Detail Modal -->
    <div id="userDetailModal" class="modal">
        <div class="modal-content">
            <div id="userDetailContent"></div>
            <div style="text-align: right; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeUserDetail()">Close</button>
            </div>
        </div>
    </div>

    <!-- Video Player Modal -->
    <div id="videoPlayerModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h2 id="videoPlayerTitle">Video Player</h2>
            <video id="videoPlayer" controls style="width: 100%; border-radius: 8px; margin: 20px 0;">
                Your browser does not support the video tag.
            </video>
            <button class="btn btn-secondary" onclick="closeVideoPlayer()">Close</button>
        </div>
    </div>

    <!-- Blip Detail Modal -->
    <div id="blipDetailModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div id="blipDetailContent"></div>
            <div style="text-align: right; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeBlipDetail()">Close</button>
            </div>
        </div>
    </div>

    <!-- Verification Detail Modal -->
    <div id="verificationDetailModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div id="verificationDetailContent"></div>
        </div>
    </div>

    <!-- Report Detail Modal -->
    <div id="reportDetailModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div id="reportDetailContent"></div>
            <div style="text-align: right; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeReportDetail()">Close</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://obtsdsztblemlbvcrcdy.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9idHNkc3p0YmxlbWxidmNyY2R5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2MDMwMjcsImV4cCI6MjA3NTE3OTAyN30.j0OJw4QuRRnbGvNj8rQ40OV8gZgGaahSP-I2MB6c8nQ';

        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let allUsers = [];
        let currentAdminId = null;
        let allAppeals = [];
        let currentAppealFilter = 'unresolved'; // Default to showing unresolved appeals
        let allReports = [];
        let currentReportFilter = 'pending'; // Default to showing pending reports
        let allVerifications = [];
        let currentVerificationFilter = 'pending'; // Default to showing pending verifications
        let dropMap = null;
        let dropMarker = null;
        let selectedDropLocation = null;
        let allAdminDrops = [];
        let dropMapMarkers = []; // Store markers for existing drops on map

        async function login() {
            console.log('Login function called');
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            console.log('Email:', email);

            try {
                console.log('Attempting sign in...');
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email,
                    password
                });

                console.log('Sign in response:', { data, error });
                if (error) {
                    alert('Login failed: ' + error.message);
                    return;
                }

                // Check if user is admin
                console.log('Checking admin status...');
                const { data: user, error: userError } = await supabaseClient
                    .from('users')
                    .select('is_admin')
                    .eq('id', data.user.id)
                    .single();

                console.log('User data:', { user, userError });
                if (userError) {
                    alert('Error checking admin status: ' + userError.message);
                    await supabaseClient.auth.signOut();
                    return;
                }

                if (!user?.is_admin) {
                    alert('Access denied. Admin privileges required.');
                    await supabaseClient.auth.signOut();
                    return;
                }

                console.log('Login successful, loading dashboard...');
                currentAdminId = data.user.id;
                document.getElementById('app').className = 'logged-in';
                loadDashboard();
            } catch (err) {
                console.error('Login error:', err);
                alert('Login failed: ' + err.message);
            }
        }

        async function logout() {
            await supabaseClient.auth.signOut();
            location.reload();
        }

        async function loadDashboard() {
            loadStats();
            loadUsers();
            loadReports();
            loadAppeals();
            loadVerifications();
        }

        async function loadStats() {
            const { count: userCount } = await supabaseClient
                .from('users')
                .select('*', { count: 'exact', head: true });

            const { count: blipCount } = await supabaseClient
                .from('blips')
                .select('*', { count: 'exact', head: true });

            const { count: bannedCount } = await supabaseClient
                .from('users')
                .select('*', { count: 'exact', head: true })
                .eq('is_banned', true);

            const { count: pendingCount } = await supabaseClient
                .from('blip_reports')
                .select('*', { count: 'exact', head: true })
                .eq('status', 'pending');

            const { count: pendingVerifications } = await supabaseClient
                .from('verification_applications')
                .select('*', { count: 'exact', head: true })
                .eq('status', 'pending');

            document.getElementById('totalUsers').textContent = userCount || 0;
            document.getElementById('totalBlips').textContent = blipCount || 0;
            document.getElementById('bannedUsers').textContent = bannedCount || 0;
            document.getElementById('pendingReports').textContent = pendingCount || 0;
            document.getElementById('pendingVerifications').textContent = pendingVerifications || 0;
        }

        async function loadUsers() {
            const { data: users, error } = await supabaseClient
                .from('users')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading users:', error);
                return;
            }

            allUsers = users;
            displayUsers(users);
        }

        function displayUsers(users) {
            if (!users || users.length === 0) {
                document.getElementById('usersTable').innerHTML = '<div class="no-results">No users found</div>';
                return;
            }

            const html = `
                <table>
                    <thead>
                        <tr>
                            <th>Avatar</th>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => `
                            <tr>
                                <td>
                                    ${user.avatar_url
                                        ? `<img src="${user.avatar_url}" class="avatar">`
                                        : `<div class="avatar" style="background: #FF6B9D; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">${user.username?.charAt(0).toUpperCase() || '?'}</div>`
                                    }
                                </td>
                                <td>
                                    <span class="clickable-username" onclick="openUserDetail('${user.id}')">@${user.username || 'N/A'}</span>
                                    ${user.is_admin ? '<span class="badge badge-admin" title="Admin User">ADMIN</span>' : ''}
                                </td>
                                <td>${user.email || 'N/A'}</td>
                                <td>
                                    ${user.is_banned ? '<span class="badge badge-banned">BANNED</span>' : '<span class="badge" style="background: #4CAF50; color: white;">ACTIVE</span>'}
                                </td>
                                <td>${new Date(user.created_at).toLocaleDateString()}</td>
                                <td>
                                    <button class="btn btn-info" onclick="openUserDetail('${user.id}')">View</button>
                                    ${user.is_banned
                                        ? `<button class="btn btn-success" onclick="unbanUser('${user.id}', '${user.username}')">Unban</button>`
                                        : `<button class="btn btn-warning" onclick="banUser('${user.id}', '${user.username}')">Ban</button>`
                                    }
                                    <button class="btn btn-danger" onclick="deleteUser('${user.id}', '${user.username}')">Delete</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('usersTable').innerHTML = html;
        }

        function searchUsers() {
            const query = document.getElementById('userSearch').value.toLowerCase().trim();

            if (!query) {
                displayUsers(allUsers);
                return;
            }

            const filtered = allUsers.filter(user =>
                user.username?.toLowerCase().includes(query) ||
                user.email?.toLowerCase().includes(query) ||
                user.id?.toLowerCase().includes(query)
            );

            displayUsers(filtered);
        }

        function clearSearch() {
            document.getElementById('userSearch').value = '';
            displayUsers(allUsers);
        }

        async function openUserDetail(userId) {
            // Get user data
            const { data: user } = await supabaseClient
                .from('users')
                .select('*')
                .eq('id', userId)
                .single();

            if (!user) return;

            // Get user stats
            const { count: followersCount } = await supabaseClient
                .from('followers')
                .select('*', { count: 'exact', head: true })
                .eq('following_id', userId);

            const { count: followingCount } = await supabaseClient
                .from('followers')
                .select('*', { count: 'exact', head: true })
                .eq('follower_id', userId);

            const { data: userBlips } = await supabaseClient
                .from('blips')
                .select('*')
                .eq('user_id', userId)
                .order('created_at', { ascending: false });

            // Get video replies sent by this user
            const { data: videoReplies } = await supabaseClient
                .from('video_replies')
                .select(`
                    *,
                    replier:users!video_replies_replied_by_fkey(id, username, avatar_url),
                    original_blip:blips!video_replies_blip_id_fkey(id, thumbnail_url, user_id, users(username))
                `)
                .eq('replied_by', userId)
                .order('created_at', { ascending: false});

            // Get video replies received by this user (replies to their blips)
            // First get the user's blip IDs
            const { data: userBlips } = await supabaseClient
                .from('blips')
                .select('id')
                .eq('user_id', userId);

            const userBlipIds = userBlips?.map(b => b.id) || [];

            // Then get video replies to those blips
            const { data: videoRepliesReceived } = userBlipIds.length > 0
                ? await supabaseClient
                    .from('video_replies')
                    .select(`
                        *,
                        replier:users!video_replies_replied_by_fkey(id, username, avatar_url),
                        original_blip:blips!video_replies_blip_id_fkey(id, thumbnail_url, user_id, users(username))
                    `)
                    .in('blip_id', userBlipIds)
                    .order('created_at', { ascending: false})
                : { data: [] };

            // Get admin action history
            const { data: adminLogs } = await supabaseClient
                .from('admin_logs')
                .select('*, admin:users!admin_logs_admin_id_fkey(username)')
                .eq('target_user_id', userId)
                .order('created_at', { ascending: false })
                .limit(20);

            const html = `
                <div class="user-detail-header">
                    ${user.avatar_url
                        ? `<img src="${user.avatar_url}" class="user-detail-avatar">`
                        : `<div class="user-detail-avatar" style="background: white; color: #FF6B9D; display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: bold;">${user.username?.charAt(0).toUpperCase() || '?'}</div>`
                    }
                    <div class="user-detail-info">
                        <h2>${user.display_name || user.username || 'N/A'}</h2>
                        <p>@${user.username || 'N/A'}</p>
                        <p>${user.email || 'No email'}</p>
                        <p>${user.bio || 'No bio'}</p>
                    </div>
                </div>

                <div class="user-stats">
                    <div class="user-stat">
                        <div class="user-stat-value">${followersCount || 0}</div>
                        <div class="user-stat-label">Followers</div>
                    </div>
                    <div class="user-stat">
                        <div class="user-stat-value">${followingCount || 0}</div>
                        <div class="user-stat-label">Following</div>
                    </div>
                    <div class="user-stat">
                        <div class="user-stat-value">${userBlips?.length || 0}</div>
                        <div class="user-stat-label">Blips</div>
                    </div>
                    <div class="user-stat">
                        <div class="user-stat-value">${user.is_banned ? 'YES' : 'NO'}</div>
                        <div class="user-stat-label">Banned</div>
                    </div>
                </div>

                <div class="action-section">
                    <h3>Admin Actions</h3>
                    <div class="action-grid">
                        ${!user.is_banned
                            ? `<button class="btn btn-warning" onclick="banUser('${user.id}', '${user.username}')">Ban User</button>`
                            : `<button class="btn btn-success" onclick="unbanUser('${user.id}', '${user.username}')">Unban User</button>`
                        }
                        ${!user.is_verified
                            ? `<button class="btn btn-primary" onclick="manualVerifyUser('${user.id}', '${user.username}')">✓ Verify User</button>`
                            : `<button class="btn btn-secondary" onclick="manualUnverifyUser('${user.id}', '${user.username}')">Remove Verification</button>`
                        }
                        <button class="btn btn-info" onclick="promptUsernameChange('${user.id}', '${user.username}')">Change Username</button>
                        <button class="btn btn-info" onclick="promptDisplayNameChange('${user.id}', '${user.display_name || ''}')">Change Display Name</button>
                        <button class="btn btn-info" onclick="promptEmailChange('${user.id}', '${user.email || ''}', '${user.username}')">Change Email</button>
                        <button class="btn btn-info" onclick="resetUserPassword('${user.id}', '${user.username}')">Reset Password</button>
                        <button class="btn btn-warning" onclick="deleteAllUserBlips('${user.id}', '${user.username}')">Delete All Blips</button>
                        <button class="btn btn-danger" onclick="deleteUser('${user.id}', '${user.username}')">Delete Account</button>
                    </div>
                </div>

                <div class="action-section">
                    <h3>User's Blips (${userBlips?.length || 0})</h3>
                    ${userBlips && userBlips.length > 0 ? `
                        <div style="display: grid; gap: 15px;">
                            ${userBlips.map(blip => `
                                <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; border-left: 4px solid #FF6B9D;">
                                    <div style="display: flex; gap: 15px; align-items: start;">
                                        <div class="blip-item" onclick="playBlipVideo('${blip.video_url}', '@${user.username}')" style="flex-shrink: 0; width: 150px;">
                                            ${blip.thumbnail_url
                                                ? `<img src="${blip.thumbnail_url}">`
                                                : `<div style="width: 100%; height: 150px; background: #ddd; display: flex; align-items: center; justify-content: center; font-size: 40px;">📹</div>`
                                            }
                                            <div class="blip-item-overlay">
                                                <div>👁️ ${blip.views_count || 0}</div>
                                            </div>
                                        </div>
                                        <div style="flex: 1;">
                                            <div style="margin-bottom: 10px;">
                                                <strong style="color: #333; font-size: 16px;">Blip Details</strong>
                                            </div>
                                            <div style="display: grid; gap: 8px; font-size: 14px; color: #666;">
                                                <div>
                                                    <strong>📅 Created:</strong> ${new Date(blip.created_at).toLocaleString()}
                                                </div>
                                                ${blip.latitude && blip.longitude ? `
                                                    <div>
                                                        <strong>📍 Location:</strong> ${blip.latitude.toFixed(6)}, ${blip.longitude.toFixed(6)}
                                                        <a href="https://www.google.com/maps?q=${blip.latitude},${blip.longitude}" target="_blank" style="color: #4A90E2; margin-left: 5px;">View on Map</a>
                                                    </div>
                                                ` : '<div><strong>📍 Location:</strong> Not available</div>'}
                                                <div>
                                                    <strong>👁️ Views:</strong> ${blip.views_count || 0}
                                                </div>
                                                <div>
                                                    <strong>🔗 ID:</strong> ${blip.id}
                                                </div>
                                                ${blip.caption ? `
                                                    <div>
                                                        <strong>💬 Caption:</strong> ${blip.caption}
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<p style="color: #999;">No blips yet</p>'}
                </div>

                <div class="action-section">
                    <h3>Video Replies Sent (${videoReplies?.length || 0})</h3>
                    ${videoReplies && videoReplies.length > 0 ? `
                        <div style="display: grid; gap: 15px;">
                            ${videoReplies.map(reply => `
                                <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; border-left: 4px solid #4A90E2;">
                                    <div style="display: flex; gap: 15px; align-items: start;">
                                        <div class="blip-item" onclick="playBlipVideo('${reply.video_url}', '@${user.username}')" style="flex-shrink: 0; width: 150px;">
                                            ${reply.thumbnail_url
                                                ? `<img src="${reply.thumbnail_url}">`
                                                : `<div style="width: 100%; height: 150px; background: #ddd; display: flex; align-items: center; justify-content: center; font-size: 40px;">📹</div>`
                                            }
                                        </div>
                                        <div style="flex: 1;">
                                            <div style="margin-bottom: 10px;">
                                                <strong style="color: #333; font-size: 16px;">Video Reply Details</strong>
                                            </div>
                                            <div style="display: grid; gap: 8px; font-size: 14px; color: #666;">
                                                <div>
                                                    <strong>📅 Sent:</strong> ${new Date(reply.created_at).toLocaleString()}
                                                </div>
                                                <div>
                                                    <strong>👤 Recipient:</strong>
                                                    <span class="clickable-username" onclick="event.stopPropagation(); openUserDetail('${reply.replier?.id}')">@${reply.replier?.username || 'Unknown'}</span>
                                                </div>
                                                <div>
                                                    <strong>💬 Reply to Blip by:</strong>
                                                    <span class="clickable-username" onclick="event.stopPropagation(); openUserDetail('${reply.original_blip?.user_id}')">@${reply.original_blip?.users?.username || 'Unknown'}</span>
                                                </div>
                                                ${reply.location_lat && reply.location_lon ? `
                                                    <div>
                                                        <strong>📍 Location:</strong> ${reply.location_lat.toFixed(6)}, ${reply.location_lon.toFixed(6)}
                                                        <a href="https://www.google.com/maps?q=${reply.location_lat},${reply.location_lon}" target="_blank" style="color: #4A90E2; margin-left: 5px;">View on Map</a>
                                                    </div>
                                                ` : '<div><strong>📍 Location:</strong> Not available</div>'}
                                                <div>
                                                    <strong>🔗 Reply ID:</strong> ${reply.id}
                                                </div>
                                                ${reply.original_blip?.id ? `
                                                    <div>
                                                        <strong>🔗 Original Blip ID:</strong> ${reply.original_blip.id}
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<p style="color: #999;">No video replies sent</p>'}
                </div>

                <div class="action-section">
                    <h3>Video Replies Received (${videoRepliesReceived?.length || 0})</h3>
                    ${videoRepliesReceived && videoRepliesReceived.length > 0 ? `
                        <div style="display: grid; gap: 15px;">
                            ${videoRepliesReceived.map(reply => `
                                <div style="background: #f0fff0; padding: 15px; border-radius: 8px; border-left: 4px solid #34C759;">
                                    <div style="display: flex; gap: 15px; align-items: start;">
                                        <div class="blip-item" onclick="playBlipVideo('${reply.video_url}', '@${reply.replier?.username || 'Unknown'}')" style="flex-shrink: 0; width: 150px;">
                                            ${reply.thumbnail_url
                                                ? `<img src="${reply.thumbnail_url}">`
                                                : `<div style="width: 100%; height: 150px; background: #ddd; display: flex; align-items: center; justify-content: center; font-size: 40px;">📹</div>`
                                            }
                                        </div>
                                        <div style="flex: 1;">
                                            <div style="margin-bottom: 10px;">
                                                <strong style="color: #333; font-size: 16px;">Video Reply Received</strong>
                                            </div>
                                            <div style="display: grid; gap: 8px; font-size: 14px; color: #666;">
                                                <div>
                                                    <strong>📅 Received:</strong> ${new Date(reply.created_at).toLocaleString()}
                                                </div>
                                                <div>
                                                    <strong>👤 From:</strong>
                                                    <span class="clickable-username" onclick="event.stopPropagation(); openUserDetail('${reply.replier?.id}')">@${reply.replier?.username || 'Unknown'}</span>
                                                </div>
                                                <div>
                                                    <strong>💬 Reply to Blip by:</strong>
                                                    <span class="clickable-username" onclick="event.stopPropagation(); openUserDetail('${reply.original_blip?.user_id}')">@${reply.original_blip?.users?.username || 'Unknown'}</span>
                                                </div>
                                                ${reply.location_lat && reply.location_lon ? `
                                                    <div>
                                                        <strong>📍 Location:</strong> ${reply.location_lat.toFixed(6)}, ${reply.location_lon.toFixed(6)}
                                                        <a href="https://www.google.com/maps?q=${reply.location_lat},${reply.location_lon}" target="_blank" style="color: #34C759; margin-left: 5px;">View on Map</a>
                                                    </div>
                                                ` : '<div><strong>📍 Location:</strong> Not available</div>'}
                                                <div>
                                                    <strong>🔗 Reply ID:</strong> ${reply.id}
                                                </div>
                                                ${reply.original_blip?.id ? `
                                                    <div>
                                                        <strong>🔗 Original Blip ID:</strong> ${reply.original_blip.id}
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<p style="color: #999;">No video replies received</p>'}
                </div>

                <div class="action-section">
                    <h3>Admin Action History</h3>
                    ${adminLogs && adminLogs.length > 0 ? `
                        ${adminLogs.map(log => `
                            <div class="history-item">
                                <div class="history-item-header">
                                    <div class="history-item-action">${formatActionType(log.action_type)}</div>
                                    <div class="history-item-date">${new Date(log.created_at).toLocaleString()}</div>
                                </div>
                                <div class="history-item-details">
                                    By: @${log.admin?.username || 'Unknown Admin'}
                                    ${log.notes ? `<br>Notes: ${log.notes}` : ''}
                                    ${log.action_details ? `<br>Details: ${JSON.stringify(log.action_details)}` : ''}
                                </div>
                            </div>
                        `).join('')}
                    ` : '<p style="color: #999;">No admin actions recorded</p>'}
                </div>
            `;

            document.getElementById('userDetailContent').innerHTML = html;
            document.getElementById('userDetailModal').classList.add('show');
        }

        function formatActionType(actionType) {
            const types = {
                'ban': '🚫 User Banned',
                'unban': '✅ User Unbanned',
                'delete_user': '🗑️ User Deleted',
                'delete_blip': '🗑️ Blip Deleted',
                'delete_video_reply': '🗑️ Video Reply Deleted',
                'delete_all_blips': '🗑️ All Blips Deleted',
                'username_change': '✏️ Username Changed',
                'display_name_change': '✏️ Display Name Changed',
                'email_change': '✉️ Email Changed',
                'password_reset': '🔑 Password Reset',
                'edit_user': '✏️ User Edited',
                'verification_approved': '✓ Verification Approved',
                'verification_rejected': '✗ Verification Rejected',
                'verification_removed': '✗ Verification Removed'
            };
            return types[actionType] || actionType;
        }

        function closeUserDetail() {
            document.getElementById('userDetailModal').classList.remove('show');
        }

        async function logAdminAction(actionType, targetUserId, actionDetails, notes) {
            console.log('Logging admin action:', { actionType, targetUserId, currentAdminId, actionDetails, notes });

            const { data, error } = await supabaseClient
                .from('admin_logs')
                .insert({
                    admin_id: currentAdminId,
                    target_user_id: targetUserId,
                    action_type: actionType,
                    action_details: actionDetails,
                    notes: notes
                });

            if (error) {
                console.error('Error logging admin action:', error);
                alert('Warning: Action completed but logging failed: ' + error.message);
            } else {
                console.log('Admin action logged successfully:', data);
            }
        }

        async function banUser(userId, username) {
            const reason = prompt(`Why are you banning @${username}?\n\nThis reason will be shown to the user.`);
            if (!reason) return;

            console.log('Attempting to ban user:', userId, username);

            const { data, error } = await supabaseClient
                .from('users')
                .update({
                    is_banned: true,
                    ban_reason: reason
                })
                .eq('id', userId);

            if (error) {
                console.error('Error banning user:', error);
                alert('Error: ' + error.message);
                return;
            }

            console.log('User banned successfully:', data);
            await logAdminAction('ban', userId, { ban_reason: reason }, reason);
            alert(`@${username} has been banned`);
            loadUsers();
            loadStats();
            closeUserDetail();
        }

        async function unbanUser(userId, username) {
            const notes = prompt(`Why are you unbanning @${username}?`);
            if (!notes) return;

            const { error } = await supabaseClient
                .from('users')
                .update({
                    is_banned: false,
                    ban_reason: null
                })
                .eq('id', userId);

            if (error) {
                alert('Error: ' + error.message);
                return;
            }

            await logAdminAction('unban', userId, null, notes);
            alert(`@${username} has been unbanned`);
            loadUsers();
            loadStats();
            closeUserDetail();
        }

        async function deleteUser(userId, username) {
            if (!confirm(`DELETE @${username} and ALL their data? This CANNOT be undone!`)) return;

            const notes = prompt('Reason for deletion:');
            if (!notes) return;

            // Use delete_user_completely function to delete both auth.users and public.users
            const { data, error } = await supabaseClient
                .rpc('delete_user_completely', { user_id_to_delete: userId });

            if (error) {
                alert('Error: ' + error.message);
                return;
            }

            if (!data) {
                alert('Failed to delete user - check database logs');
                return;
            }

            await logAdminAction('delete_user', userId, null, notes);
            alert(`@${username} deleted completely (both auth and profile)`);
            loadUsers();
            loadStats();
            closeUserDetail();
        }

        async function promptUsernameChange(userId, currentUsername) {
            const newUsername = prompt(`Change username from @${currentUsername} to:`, currentUsername);
            if (!newUsername || newUsername === currentUsername) return;

            const { error } = await supabaseClient
                .from('users')
                .update({ username: newUsername })
                .eq('id', userId);

            if (error) {
                alert('Error: ' + error.message);
                return;
            }

            await logAdminAction('username_change', userId, { from: currentUsername, to: newUsername }, `Changed username from @${currentUsername} to @${newUsername}`);
            alert(`Username changed to @${newUsername}`);
            loadUsers();
            openUserDetail(userId);
        }

        async function promptDisplayNameChange(userId, currentDisplayName) {
            const newDisplayName = prompt(`Change display name from "${currentDisplayName}" to:`, currentDisplayName);
            if (newDisplayName === null || newDisplayName === currentDisplayName) return;

            const { error } = await supabaseClient
                .from('users')
                .update({ display_name: newDisplayName })
                .eq('id', userId);

            if (error) {
                alert('Error: ' + error.message);
                return;
            }

            await logAdminAction('display_name_change', userId, { from: currentDisplayName, to: newDisplayName }, `Changed display name from "${currentDisplayName}" to "${newDisplayName}"`);
            alert(`Display name changed to "${newDisplayName}"`);
            loadUsers();
            openUserDetail(userId);
        }

        async function promptEmailChange(userId, currentEmail, username) {
            const newEmail = prompt(`Change email for @${username} from "${currentEmail}" to:`, currentEmail);
            if (!newEmail || newEmail === currentEmail) return;

            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(newEmail)) {
                alert('Invalid email format. Please enter a valid email address.');
                return;
            }

            if (!confirm(`Are you sure you want to change the email from "${currentEmail}" to "${newEmail}"?\n\nThis will update both auth.users and public.users tables.`)) {
                return;
            }

            try {
                // Update public.users table
                const { error: publicError } = await supabaseClient
                    .from('users')
                    .update({ email: newEmail })
                    .eq('id', userId);

                if (publicError) {
                    alert('Error updating public.users: ' + publicError.message);
                    return;
                }

                // Update auth.users table using the admin updateUserById method
                const { error: authError } = await supabaseClient.auth.admin.updateUserById(
                    userId,
                    { email: newEmail }
                );

                if (authError) {
                    // Rollback public.users change
                    await supabaseClient
                        .from('users')
                        .update({ email: currentEmail })
                        .eq('id', userId);

                    alert('Error updating auth.users (changes rolled back): ' + authError.message);
                    return;
                }

                await logAdminAction('email_change', userId, { from: currentEmail, to: newEmail }, `Changed email from "${currentEmail}" to "${newEmail}"`);
                alert(`Email successfully changed to "${newEmail}"\n\nBoth auth.users and public.users have been updated.`);
                loadUsers();
                openUserDetail(userId);
            } catch (error) {
                alert('Error changing email: ' + error.message);
                console.error('Email change error:', error);
            }
        }

        async function resetUserPassword(userId, username) {
            const notes = prompt(`Notes for password reset for @${username}:`);
            if (!notes) return;

            await logAdminAction('password_reset', userId, null, notes);
            alert(`Password reset logged for @${username}. User must reset via email.`);
        }

        async function deleteAllUserBlips(userId, username) {
            if (!confirm(`Delete ALL blips by @${username}? This CANNOT be undone!`)) return;

            const { error } = await supabaseClient
                .from('blips')
                .delete()
                .eq('user_id', userId);

            if (error) {
                alert('Error: ' + error.message);
                return;
            }

            await logAdminAction('delete_all_blips', userId, null, `Deleted all blips by @${username}`);
            alert(`All blips by @${username} deleted`);
            loadStats();
            openUserDetail(userId);
        }

        async function manualVerifyUser(userId, username) {
            const notes = prompt(`Why are you manually verifying @${username}?\n\nThis will give them a blue checkmark.`);
            if (!notes) return;

            const { error } = await supabaseClient
                .from('users')
                .update({ is_verified: true })
                .eq('id', userId);

            if (error) {
                alert('Error: ' + error.message);
                return;
            }

            await logAdminAction('verification_approved', userId, { manual: true }, `Manually verified: ${notes}`);
            alert(`@${username} has been verified!`);
            loadUsers();
            openUserDetail(userId);
        }

        async function manualUnverifyUser(userId, username) {
            const notes = prompt(`Why are you removing verification from @${username}?`);
            if (!notes) return;

            const { error } = await supabaseClient
                .from('users')
                .update({ is_verified: false })
                .eq('id', userId);

            if (error) {
                alert('Error: ' + error.message);
                return;
            }

            await logAdminAction('verification_removed', userId, { manual: true }, `Removed verification: ${notes}`);
            alert(`Verification removed from @${username}`);
            loadUsers();
            openUserDetail(userId);
        }

        async function searchUsersForBlips() {
            const query = document.getElementById('blipUserSearch').value.toLowerCase().trim();

            if (!query) {
                document.getElementById('blipsSearchResults').innerHTML = '<div class="no-results">Enter a username, email, or ID to search</div>';
                return;
            }

            // Search for users
            const filtered = allUsers.filter(user =>
                user.username?.toLowerCase().includes(query) ||
                user.email?.toLowerCase().includes(query) ||
                user.id?.toLowerCase().includes(query)
            );

            if (filtered.length === 0) {
                document.getElementById('blipsSearchResults').innerHTML = '<div class="no-results">No users found matching your search</div>';
                return;
            }

            // Get blip counts for each user
            const usersWithBlipCounts = await Promise.all(
                filtered.map(async (user) => {
                    const { count } = await supabaseClient
                        .from('blips')
                        .select('*', { count: 'exact', head: true })
                        .eq('user_id', user.id);
                    return { ...user, blip_count: count || 0 };
                })
            );

            const html = `
                <h3 style="margin-bottom: 15px; color: #666;">Search Results (${filtered.length} user${filtered.length !== 1 ? 's' : ''} found)</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Avatar</th>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Blips</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${usersWithBlipCounts.map(user => `
                            <tr>
                                <td>
                                    ${user.avatar_url
                                        ? `<img src="${user.avatar_url}" class="avatar">`
                                        : `<div class="avatar" style="background: #FF6B9D; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">${user.username?.charAt(0).toUpperCase() || '?'}</div>`
                                    }
                                </td>
                                <td>
                                    <span class="clickable-username" onclick="openUserDetail('${user.id}')">@${user.username || 'N/A'}</span>
                                    ${user.is_admin ? '<span class="badge badge-admin" title="Admin User">ADMIN</span>' : ''}
                                </td>
                                <td>${user.email || 'N/A'}</td>
                                <td><strong style="color: #FF6B9D;">${user.blip_count}</strong> blip${user.blip_count !== 1 ? 's' : ''}</td>
                                <td>
                                    ${user.is_banned ? '<span class="badge badge-banned">BANNED</span>' : '<span class="badge" style="background: #4CAF50; color: white;">ACTIVE</span>'}
                                </td>
                                <td>
                                    <button class="btn btn-info" onclick="openUserDetail('${user.id}')">View Profile & Blips</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('blipsSearchResults').innerHTML = html;
        }

        function clearBlipUserSearch() {
            document.getElementById('blipUserSearch').value = '';
            document.getElementById('blipsSearchResults').innerHTML = '<div class="no-results">Enter a username, email, or ID to search</div>';
        }

        async function loadReports() {
            const { data: blipReports } = await supabaseClient
                .from('blip_reports')
                .select(`
                    *,
                    blips(id, video_url, thumbnail_url, user_id, title, description, latitude, longitude, views_count, created_at, is_public),
                    users!blip_reports_reported_by_fkey(username),
                    blip_owner:users!blip_reports_blip_owner_id_fkey(id, username)
                `)
                .order('created_at', { ascending: false });

            const { data: profileReports } = await supabaseClient
                .from('profile_reports')
                .select(`
                    *,
                    reported_user:users!profile_reports_reported_user_id_fkey(id, username, avatar_url),
                    reporter:users!profile_reports_reported_by_fkey(username)
                `)
                .neq('report_type', 'appeal') // Exclude appeals from reports
                .order('created_at', { ascending: false });

            // Load video reply reports
            const { data: videoReplyReports } = await supabaseClient
                .from('video_reply_reports')
                .select(`
                    *,
                    video_reply:video_replies(
                        id,
                        video_url,
                        thumbnail_url,
                        replied_by,
                        blip_id,
                        location_lat,
                        location_lon,
                        created_at,
                        replier:users!video_replies_replied_by_fkey(id, username),
                        original_blip:blips!video_replies_blip_id_fkey(id, user_id, users(username))
                    ),
                    reporter:users!video_reply_reports_reported_by_fkey(username, id)
                `)
                .order('created_at', { ascending: false });

            allReports = [
                ...(blipReports || []).map(r => ({ ...r, reportType: 'blip' })),
                ...(profileReports || []).map(r => ({ ...r, reportType: 'profile' })),
                ...(videoReplyReports || []).map(r => ({ ...r, reportType: 'video_reply' }))
            ].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            filterReports();
        }

        function setReportFilter(filter) {
            currentReportFilter = filter;

            // Update button styles
            document.getElementById('filterReportsPending').className = filter === 'pending' ? 'btn btn-primary' : 'btn btn-secondary';
            document.getElementById('filterReportsResolved').className = filter === 'resolved' ? 'btn btn-primary' : 'btn btn-secondary';
            document.getElementById('filterReportsAll').className = filter === 'all' ? 'btn btn-primary' : 'btn btn-secondary';

            filterReports();
        }

        function clearReportSearch() {
            document.getElementById('reportSearch').value = '';
            filterReports();
        }

        function filterReports() {
            const searchQuery = document.getElementById('reportSearch').value.toLowerCase().trim();

            // Filter by status
            let filtered = allReports.filter(report => {
                if (currentReportFilter === 'pending') {
                    return report.status === 'pending';
                } else if (currentReportFilter === 'resolved') {
                    return report.status === 'reviewed' || report.status === 'dismissed';
                }
                return true; // 'all' filter
            });

            // Filter by search query
            if (searchQuery) {
                filtered = filtered.filter(report => {
                    if (report.reportType === 'blip') {
                        return report.users?.username?.toLowerCase().includes(searchQuery) ||
                               report.blip_owner?.username?.toLowerCase().includes(searchQuery);
                    } else if (report.reportType === 'video_reply') {
                        return report.reporter?.username?.toLowerCase().includes(searchQuery) ||
                               report.video_reply?.sender?.username?.toLowerCase().includes(searchQuery) ||
                               report.video_reply?.recipient?.username?.toLowerCase().includes(searchQuery);
                    } else {
                        return report.reporter?.username?.toLowerCase().includes(searchQuery) ||
                               report.reported_user?.username?.toLowerCase().includes(searchQuery);
                    }
                });
            }

            displayReports(filtered);
        }

        function displayReports(reports) {
            if (!reports || reports.length === 0) {
                document.getElementById('reportsTable').innerHTML = '<div class="no-results">No reports found</div>';
                return;
            }

            const html = `
                <table>
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Content</th>
                            <th>Reported By</th>
                            <th>Reported User</th>
                            <th>Reason</th>
                            <th>Details</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${reports.map(report => {
                            let badgeColor, badgeTextColor, reportedByUser, reportedUser, reportedUserId;

                            if (report.reportType === 'blip') {
                                badgeColor = '#FFE8F0';
                                badgeTextColor = '#FF6B9D';
                                reportedByUser = report.users?.username;
                                reportedUser = report.blip_owner?.username;
                                reportedUserId = report.blip_owner_id;
                            } else if (report.reportType === 'video_reply') {
                                badgeColor = '#FFF4E6';
                                badgeTextColor = '#FF8C00';
                                reportedByUser = report.reporter?.username;
                                reportedUser = report.video_reply?.sender?.username;
                                reportedUserId = report.video_reply?.sender_id;
                            } else {
                                badgeColor = '#E8F0FF';
                                badgeTextColor = '#4A90E2';
                                reportedByUser = report.reporter?.username;
                                reportedUser = report.reported_user?.username;
                                reportedUserId = report.reported_user_id;
                            }

                            return `
                            <tr>
                                <td><span class="badge" style="background: ${badgeColor}; color: ${badgeTextColor};">${report.reportType.toUpperCase().replace('_', ' ')}</span></td>
                                <td>
                                    ${report.reportType === 'blip' && report.blips?.thumbnail_url
                                        ? `<img src="${report.blips.thumbnail_url}" style="width: 60px; height: 60px; border-radius: 8px; cursor: pointer;" onclick="playBlipVideo('${report.blips.video_url}', 'Reported')">`
                                        : report.reportType === 'video_reply' && report.video_reply?.thumbnail_url
                                            ? `<img src="${report.video_reply.thumbnail_url}" style="width: 60px; height: 60px; border-radius: 8px; cursor: pointer;" onclick="playBlipVideo('${report.video_reply.video_url}', 'Video Reply')">`
                                            : report.reportType === 'profile' && report.reported_user?.avatar_url
                                                ? `<img src="${report.reported_user.avatar_url}" class="avatar">`
                                                : '📹'
                                    }
                                </td>
                                <td>
                                    <span class="clickable-username" onclick="openUserDetail('${report.reported_by}')">
                                        @${reportedByUser || 'Unknown'}
                                    </span>
                                </td>
                                <td>
                                    <span class="clickable-username" onclick="openUserDetail('${reportedUserId}')">
                                        @${reportedUser || 'Unknown'}
                                    </span>
                                </td>
                                <td>${report.reason}</td>
                                <td style="max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${report.details || 'No additional details'}">${report.details || '-'}</td>
                                <td><span class="badge" style="background: ${report.status === 'pending' ? '#FFA500' : '#4CAF50'}; color: white;">${report.status}</span></td>
                                <td>
                                    <button class="btn btn-primary" onclick="openReportDetail('${report.id}', '${report.reportType}')">View Report</button>
                                    <select
                                        class="status-dropdown"
                                        onchange="updateReportStatus('${report.id}', this.value, '${report.reportType}')"
                                        style="padding: 8px 12px; border-radius: 6px; border: 2px solid #ddd; font-size: 14px; cursor: pointer; background: white; margin-top: 5px;"
                                    >
                                        <option value="${report.status}" selected>${report.status}</option>
                                        ${report.status !== 'pending' ? '<option value="pending">pending</option>' : ''}
                                        ${report.status !== 'reviewed' ? '<option value="reviewed">reviewed</option>' : ''}
                                        ${report.status !== 'dismissed' ? '<option value="dismissed">dismissed</option>' : ''}
                                    </select>
                                </td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('reportsTable').innerHTML = html || '<div class="no-results">No reports</div>';
        }

        async function updateReportStatus(reportId, status, reportType) {
            let tableName;
            if (reportType === 'blip') {
                tableName = 'blip_reports';
            } else if (reportType === 'video_reply') {
                tableName = 'video_reply_reports';
            } else {
                tableName = 'profile_reports';
            }

            const { error } = await supabaseClient
                .from(tableName)
                .update({
                    status: status,
                    reviewed_by: currentAdminId,
                    reviewed_at: new Date().toISOString()
                })
                .eq('id', reportId);

            if (error) {
                alert('Error: ' + error.message);
                return;
            }

            alert(`Report status updated to: ${status}`);
            loadReports();
            loadStats();
        }

        function playBlipVideo(videoUrl, username) {
            document.getElementById('videoPlayerTitle').textContent = `Video by ${username}`;
            document.getElementById('videoPlayer').src = videoUrl;
            document.getElementById('videoPlayerModal').classList.add('show');
        }

        function closeVideoPlayer() {
            document.getElementById('videoPlayer').pause();
            document.getElementById('videoPlayer').src = '';
            document.getElementById('videoPlayerModal').classList.remove('show');
        }

        async function loadAppeals() {
            const { data: appeals } = await supabaseClient
                .from('profile_reports')
                .select(`
                    id,
                    reported_user_id,
                    reported_by,
                    reason,
                    details,
                    status,
                    reviewed_by,
                    reviewed_at,
                    created_at,
                    report_type,
                    reported_user:users!profile_reports_reported_user_id_fkey(id, username, avatar_url, is_banned, email)
                `)
                .eq('report_type', 'appeal')
                .order('created_at', { ascending: false });

            allAppeals = appeals || [];
            filterAppeals();
        }

        function setAppealFilter(filter) {
            currentAppealFilter = filter;

            // Update button styles
            document.getElementById('filterUnresolved').className = filter === 'unresolved' ? 'btn btn-primary' : 'btn btn-secondary';
            document.getElementById('filterResolved').className = filter === 'resolved' ? 'btn btn-primary' : 'btn btn-secondary';
            document.getElementById('filterAll').className = filter === 'all' ? 'btn btn-primary' : 'btn btn-secondary';

            filterAppeals();
        }

        function clearAppealSearch() {
            document.getElementById('appealSearch').value = '';
            filterAppeals();
        }

        function filterAppeals() {
            const searchQuery = document.getElementById('appealSearch').value.toLowerCase().trim();

            // Filter by status
            let filtered = allAppeals.filter(appeal => {
                if (currentAppealFilter === 'unresolved') {
                    return appeal.status === 'pending';
                } else if (currentAppealFilter === 'resolved') {
                    return appeal.status === 'reviewed' || appeal.status === 'dismissed';
                }
                return true; // 'all' filter
            });

            // Filter by search query
            if (searchQuery) {
                filtered = filtered.filter(appeal =>
                    appeal.reported_user?.username?.toLowerCase().includes(searchQuery) ||
                    appeal.reported_user?.email?.toLowerCase().includes(searchQuery)
                );
            }

            displayAppeals(filtered);
        }

        function displayAppeals(appeals) {
            if (!appeals || appeals.length === 0) {
                document.getElementById('appealsTable').innerHTML = '<div class="no-results">No appeals found</div>';
                return;
            }

            const html = `
                <table>
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Email</th>
                            <th>Appeal Reason</th>
                            <th>Status</th>
                            <th>Submitted</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${appeals.map(appeal => {
                            // Extract appeal text from details field (format: "BAN APPEAL (Code: 12345)\n\nUser's reason")
                            const appealText = appeal.details || appeal.reason || 'No reason provided';
                            return `
                            <tr>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        ${appeal.reported_user?.avatar_url
                                            ? `<img src="${appeal.reported_user.avatar_url}" class="avatar">`
                                            : `<div class="avatar" style="background: #FF6B9D; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">${appeal.reported_user?.username?.charAt(0).toUpperCase() || '?'}</div>`
                                        }
                                        <div>
                                            <span class="clickable-username" onclick="openUserDetail('${appeal.reported_user_id}')">@${appeal.reported_user?.username || 'Unknown'}</span>
                                            ${appeal.reported_user?.is_banned ? '<br><span class="badge badge-banned">BANNED</span>' : '<br><span class="badge" style="background: #4CAF50; color: white;">ACTIVE</span>'}
                                        </div>
                                    </div>
                                </td>
                                <td>${appeal.reported_user?.email || 'N/A'}</td>
                                <td style="max-width: 300px; white-space: pre-wrap; word-wrap: break-word;">${appealText || 'No reason provided'}</td>
                                <td><span class="badge" style="background: ${appeal.status === 'pending' ? '#FFA500' : appeal.status === 'reviewed' ? '#4CAF50' : '#999'}; color: white;">${appeal.status}</span></td>
                                <td>${new Date(appeal.created_at).toLocaleString()}</td>
                                <td>
                                    ${appeal.status === 'pending' && appeal.reported_user?.is_banned ? `
                                        <button class="btn btn-success" onclick="approveAppeal('${appeal.id}', '${appeal.reported_user_id}', '${appeal.reported_user?.username}')">Approve & Unban</button>
                                        <button class="btn btn-danger" onclick="denyAppeal('${appeal.id}', '${appeal.reported_user?.username}')">Deny</button>
                                        <br>
                                    ` : appeal.status === 'pending' && !appeal.reported_user?.is_banned ? `
                                        <button class="btn btn-info" onclick="markAppealReviewed('${appeal.id}')">Mark Reviewed</button>
                                        <span style="color: #666; font-size: 12px;">(Already unbanned)</span>
                                        <br>
                                    ` : ''}
                                    <div style="display: flex; gap: 8px; align-items: center; margin-top: ${appeal.status === 'pending' ? '8px' : '0'};">
                                        <select
                                            class="status-dropdown"
                                            onchange="updateAppealStatus('${appeal.id}', this.value)"
                                            style="padding: 8px 12px; border-radius: 6px; border: 2px solid #ddd; font-size: 14px; cursor: pointer; background: white;"
                                        >
                                            <option value="${appeal.status}" selected>${appeal.status}</option>
                                            ${appeal.status !== 'pending' ? '<option value="pending">pending</option>' : ''}
                                            ${appeal.status !== 'reviewed' ? '<option value="reviewed">reviewed</option>' : ''}
                                            ${appeal.status !== 'dismissed' ? '<option value="dismissed">dismissed</option>' : ''}
                                        </select>
                                        <button class="btn btn-info" onclick="openUserDetail('${appeal.reported_user_id}')">View User</button>
                                    </div>
                                </td>
                            </tr>
                        `;
                        }).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('appealsTable').innerHTML = html;
        }

        async function approveAppeal(appealId, userId, username) {
            const notes = prompt(`Notes for approving appeal for @${username}:`);
            if (!notes) return;

            // Unban the user and clear ban reason
            const { error: unbanError } = await supabaseClient
                .from('users')
                .update({
                    is_banned: false,
                    ban_reason: null
                })
                .eq('id', userId);

            if (unbanError) {
                alert('Error unbanning user: ' + unbanError.message);
                return;
            }

            // Mark appeal as reviewed
            const { error: appealError } = await supabaseClient
                .from('profile_reports')
                .update({ status: 'reviewed', reviewed_by: currentAdminId, reviewed_at: new Date().toISOString() })
                .eq('id', appealId);

            if (appealError) {
                alert('Error updating appeal: ' + appealError.message);
                return;
            }

            // Log the action
            await logAdminAction('unban', userId, { appeal_approved: true }, `Appeal approved: ${notes}`);

            alert(`Appeal approved! @${username} has been unbanned.`);
            loadAppeals();
            loadStats();
        }

        async function denyAppeal(appealId, username) {
            const notes = prompt(`Notes for denying appeal for @${username}:`);
            if (!notes) return;

            const { error } = await supabaseClient
                .from('profile_reports')
                .update({ status: 'dismissed', reviewed_by: currentAdminId, reviewed_at: new Date().toISOString() })
                .eq('id', appealId);

            if (error) {
                alert('Error: ' + error.message);
                return;
            }

            alert(`Appeal denied for @${username}`);
            loadAppeals();
        }

        async function markAppealReviewed(appealId) {
            const { error } = await supabaseClient
                .from('profile_reports')
                .update({ status: 'reviewed', reviewed_by: currentAdminId, reviewed_at: new Date().toISOString() })
                .eq('id', appealId);

            if (error) {
                alert('Error: ' + error.message);
                return;
            }

            alert('Appeal marked as reviewed');
            loadAppeals();
        }

        async function updateAppealStatus(appealId, status) {
            const { error } = await supabaseClient
                .from('profile_reports')
                .update({
                    status: status,
                    reviewed_by: currentAdminId,
                    reviewed_at: new Date().toISOString()
                })
                .eq('id', appealId);

            if (error) {
                alert('Error: ' + error.message);
                return;
            }

            alert(`Appeal status updated to: ${status}`);
            loadAppeals();
        }

        async function openBlipDetail(blipId, ownerUsername) {
            // Fetch full blip details
            const { data: blip, error } = await supabaseClient
                .from('blips')
                .select('*, users(id, username, avatar_url)')
                .eq('id', blipId)
                .single();

            if (error || !blip) {
                alert('Error loading blip: ' + (error?.message || 'Blip not found'));
                return;
            }

            const html = `
                <h2 style="margin-bottom: 20px;">Reported Blip Details</h2>

                <div style="background: #f9f9f9; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                        ${blip.users?.avatar_url
                            ? `<img src="${blip.users.avatar_url}" class="avatar">`
                            : `<div class="avatar" style="background: #FF6B9D; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">${blip.users?.username?.charAt(0).toUpperCase() || '?'}</div>`
                        }
                        <div>
                            <span class="clickable-username" onclick="closeBlipDetail(); openUserDetail('${blip.user_id}')">@${blip.users?.username || 'Unknown'}</span>
                            <p style="color: #999; font-size: 12px; margin-top: 5px;">Posted on ${new Date(blip.created_at).toLocaleString()}</p>
                        </div>
                    </div>

                    <video controls style="width: 100%; border-radius: 8px; margin-bottom: 20px; max-height: 400px;">
                        <source src="${blip.video_url}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>

                    <div style="margin-bottom: 15px;">
                        <strong style="color: #333;">Title:</strong>
                        <p style="color: #666; margin-top: 5px;">${blip.title || 'No title'}</p>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <strong style="color: #333;">Description:</strong>
                        <p style="color: #666; margin-top: 5px;">${blip.description || 'No description'}</p>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
                        <div>
                            <strong style="color: #333;">Location:</strong>
                            <p style="color: #666; margin-top: 5px;">
                                ${blip.latitude && blip.longitude
                                    ? `📍 ${blip.latitude.toFixed(6)}, ${blip.longitude.toFixed(6)}<br><a href="https://www.google.com/maps?q=${blip.latitude},${blip.longitude}" target="_blank" style="color: #4A90E2;">View on Google Maps</a>`
                                    : 'No location data'
                                }
                            </p>
                        </div>
                        <div>
                            <strong style="color: #333;">Views:</strong>
                            <p style="color: #666; margin-top: 5px;">👁️ ${blip.views_count || 0} views</p>
                        </div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <strong style="color: #333;">Visibility:</strong>
                        <p style="color: #666; margin-top: 5px;">
                            ${blip.is_public ? '🌍 Public' : '🔒 Private'}
                        </p>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn btn-info" onclick="closeBlipDetail(); openUserDetail('${blip.user_id}')">View User Profile</button>
                    <button class="btn btn-danger" onclick="deleteBlipFromDetail('${blip.id}', '@${blip.users?.username || 'Unknown'}')">Delete Blip</button>
                </div>
            `;

            document.getElementById('blipDetailContent').innerHTML = html;
            document.getElementById('blipDetailModal').classList.add('show');
        }

        function closeBlipDetail() {
            document.getElementById('blipDetailModal').classList.remove('show');
        }

        async function deleteBlipFromDetail(blipId, username) {
            if (!confirm(`Delete this blip by ${username}? This CANNOT be undone!`)) return;

            const { error } = await supabaseClient
                .from('blips')
                .delete()
                .eq('id', blipId);

            if (error) {
                alert('Error: ' + error.message);
                return;
            }

            await logAdminAction('delete_blip', null, { blip_id: blipId }, `Deleted reported blip by ${username}`);
            alert('Blip deleted successfully');
            closeBlipDetail();
            loadReports();
            loadStats();
        }

        async function openReportDetail(reportId, reportType) {
            // Find the report in allReports array
            const report = allReports.find(r => r.id === reportId && r.reportType === reportType);

            if (!report) {
                alert('Report not found');
                return;
            }

            let html = '';

            if (reportType === 'blip') {
                // Blip report
                const blip = report.blips;
                const reporter = report.users;
                const owner = report.blip_owner;

                html = `
                    <h2 style="margin-bottom: 20px;">Blip Report Details</h2>

                    <div style="background: #FFE8F0; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #FF6B9D;">
                        <h3 style="color: #FF6B9D; margin-bottom: 15px;">Report Information</h3>

                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
                            <div>
                                <strong style="color: #333;">Category:</strong>
                                <p style="color: #666; margin-top: 5px;">${report.reason}</p>
                            </div>
                            <div>
                                <strong style="color: #333;">Status:</strong>
                                <p style="margin-top: 5px;">
                                    <span class="badge" style="background: ${report.status === 'pending' ? '#FFA500' : '#4CAF50'}; color: white;">${report.status}</span>
                                </p>
                            </div>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <strong style="color: #333;">Additional Details:</strong>
                            <p style="color: #666; margin-top: 5px; white-space: pre-wrap; background: white; padding: 10px; border-radius: 6px;">${report.details || 'No additional details provided'}</p>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div>
                                <strong style="color: #333;">Reported By:</strong>
                                <p style="margin-top: 5px;">
                                    <span class="clickable-username" onclick="closeReportDetail(); openUserDetail('${report.reported_by}')">@${reporter?.username || 'Unknown'}</span>
                                </p>
                            </div>
                            <div>
                                <strong style="color: #333;">Reported On:</strong>
                                <p style="color: #666; margin-top: 5px;">${new Date(report.created_at).toLocaleString()}</p>
                            </div>
                        </div>
                    </div>

                    ${blip ? `
                        <div style="background: #f9f9f9; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                            <h3 style="color: #333; margin-bottom: 15px;">Reported Blip</h3>

                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                                ${owner?.username ? `
                                    <div>
                                        <strong style="color: #333;">Blip Owner:</strong>
                                        <span class="clickable-username" onclick="closeReportDetail(); openUserDetail('${report.blip_owner_id}')">@${owner.username}</span>
                                    </div>
                                ` : ''}
                            </div>

                            <video controls style="width: 100%; border-radius: 8px; margin-bottom: 20px; max-height: 400px; background: #000;">
                                <source src="${blip.video_url}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>

                            <div style="margin-bottom: 15px;">
                                <strong style="color: #333;">Title:</strong>
                                <p style="color: #666; margin-top: 5px;">${blip.title || 'No title'}</p>
                            </div>

                            <div style="margin-bottom: 15px;">
                                <strong style="color: #333;">Description:</strong>
                                <p style="color: #666; margin-top: 5px;">${blip.description || 'No description'}</p>
                            </div>

                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <strong style="color: #333;">Location:</strong>
                                    <p style="color: #666; margin-top: 5px;">
                                        ${blip.latitude && blip.longitude
                                            ? `📍 ${blip.latitude.toFixed(6)}, ${blip.longitude.toFixed(6)}<br><a href="https://www.google.com/maps?q=${blip.latitude},${blip.longitude}" target="_blank" style="color: #4A90E2;">View on Google Maps</a>`
                                            : 'No location data'
                                        }
                                    </p>
                                </div>
                                <div>
                                    <strong style="color: #333;">Views:</strong>
                                    <p style="color: #666; margin-top: 5px;">👁️ ${blip.views_count || 0} views</p>
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                <div>
                                    <strong style="color: #333;">Visibility:</strong>
                                    <p style="color: #666; margin-top: 5px;">
                                        ${blip.is_public ? '🌍 Public' : '🔒 Private'}
                                    </p>
                                </div>
                                <div>
                                    <strong style="color: #333;">Uploaded:</strong>
                                    <p style="color: #666; margin-top: 5px;">${new Date(blip.created_at).toLocaleString()}</p>
                                </div>
                            </div>
                        </div>
                    ` : '<p style="color: #999;">Blip has been deleted</p>'}

                    <div style="display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap;">
                        <button class="btn btn-info" onclick="closeReportDetail(); openUserDetail('${report.reported_by}')">View Reporter Profile</button>
                        ${blip ? `
                            <button class="btn btn-info" onclick="closeReportDetail(); openUserDetail('${report.blip_owner_id}')">View Owner Profile</button>
                            <button class="btn btn-danger" onclick="deleteBlipFromReport('${blip.id}', '@${owner?.username || 'Unknown'}', '${report.id}')">Delete Blip</button>
                        ` : ''}
                        <select
                            onchange="updateReportStatusFromDetail('${report.id}', this.value, '${reportType}')"
                            style="padding: 8px 12px; border-radius: 6px; border: 2px solid #ddd; font-size: 14px; cursor: pointer; background: white;"
                        >
                            <option value="${report.status}" selected>${report.status}</option>
                            ${report.status !== 'pending' ? '<option value="pending">pending</option>' : ''}
                            ${report.status !== 'reviewed' ? '<option value="reviewed">reviewed</option>' : ''}
                            ${report.status !== 'dismissed' ? '<option value="dismissed">dismissed</option>' : ''}
                        </select>
                    </div>
                `;
            } else if (reportType === 'video_reply') {
                // Video reply report
                const videoReply = report.video_reply;
                const reporter = report.reporter;
                const sender = videoReply?.sender;
                const recipient = videoReply?.recipient;
                const originalBlip = videoReply?.original_blip;

                html = `
                    <h2 style="margin-bottom: 20px;">Video Reply Report Details</h2>

                    <div style="background: #FFF4E6; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #FF8C00;">
                        <h3 style="color: #FF8C00; margin-bottom: 15px;">Report Information</h3>

                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
                            <div>
                                <strong style="color: #333;">Category:</strong>
                                <p style="color: #666; margin-top: 5px;">${report.reason}</p>
                            </div>
                            <div>
                                <strong style="color: #333;">Status:</strong>
                                <p style="margin-top: 5px;">
                                    <span class="badge" style="background: ${report.status === 'pending' ? '#FFA500' : '#4CAF50'}; color: white;">${report.status}</span>
                                </p>
                            </div>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <strong style="color: #333;">Additional Details:</strong>
                            <p style="color: #666; margin-top: 5px; white-space: pre-wrap; background: white; padding: 10px; border-radius: 6px;">${report.details || 'No additional details provided'}</p>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div>
                                <strong style="color: #333;">Reported By:</strong>
                                <p style="margin-top: 5px;">
                                    <span class="clickable-username" onclick="closeReportDetail(); openUserDetail('${report.reported_by}')">@${reporter?.username || 'Unknown'}</span>
                                </p>
                            </div>
                            <div>
                                <strong style="color: #333;">Reported On:</strong>
                                <p style="color: #666; margin-top: 5px;">${new Date(report.created_at).toLocaleString()}</p>
                            </div>
                        </div>
                    </div>

                    ${videoReply ? `
                        <div style="background: #f9f9f9; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                            <h3 style="color: #333; margin-bottom: 15px;">Reported Video Reply</h3>

                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                                <div>
                                    <strong style="color: #333;">Sent By:</strong>
                                    <p style="margin-top: 5px;">
                                        <span class="clickable-username" onclick="closeReportDetail(); openUserDetail('${videoReply.sender_id}')">@${sender?.username || 'Unknown'}</span>
                                    </p>
                                </div>
                                <div>
                                    <strong style="color: #333;">Sent To:</strong>
                                    <p style="margin-top: 5px;">
                                        <span class="clickable-username" onclick="closeReportDetail(); openUserDetail('${videoReply.recipient_id}')">@${recipient?.username || 'Unknown'}</span>
                                    </p>
                                </div>
                            </div>

                            <div style="margin-bottom: 15px;">
                                <strong style="color: #333;">Reply to Blip by:</strong>
                                <p style="margin-top: 5px;">
                                    <span class="clickable-username" onclick="closeReportDetail(); openUserDetail('${originalBlip?.user_id}')">@${originalBlip?.users?.username || 'Unknown'}</span>
                                    ${originalBlip?.id ? `<span style="color: #999; margin-left: 10px;">(Blip ID: ${originalBlip.id})</span>` : ''}
                                </p>
                            </div>

                            <video controls style="width: 100%; border-radius: 8px; margin-bottom: 20px; max-height: 400px; background: #000;">
                                <source src="${videoReply.video_url}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>

                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <strong style="color: #333;">Location:</strong>
                                    <p style="color: #666; margin-top: 5px;">
                                        ${videoReply.latitude && videoReply.longitude
                                            ? `📍 ${videoReply.latitude.toFixed(6)}, ${videoReply.longitude.toFixed(6)}<br><a href="https://www.google.com/maps?q=${videoReply.latitude},${videoReply.longitude}" target="_blank" style="color: #4A90E2;">View on Google Maps</a>`
                                            : 'No location data'
                                        }
                                    </p>
                                </div>
                                <div>
                                    <strong style="color: #333;">Sent:</strong>
                                    <p style="color: #666; margin-top: 5px;">${new Date(videoReply.created_at).toLocaleString()}</p>
                                </div>
                            </div>
                        </div>
                    ` : '<p style="color: #999;">Video reply has been deleted</p>'}

                    <div style="display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap;">
                        <button class="btn btn-info" onclick="closeReportDetail(); openUserDetail('${report.reported_by}')">View Reporter Profile</button>
                        ${videoReply ? `
                            <button class="btn btn-info" onclick="closeReportDetail(); openUserDetail('${videoReply.sender_id}')">View Sender Profile</button>
                            <button class="btn btn-danger" onclick="deleteVideoReplyFromReport('${videoReply.id}', '@${sender?.username || 'Unknown'}', '${report.id}')">Delete Video Reply</button>
                        ` : ''}
                        <select
                            onchange="updateReportStatusFromDetail('${report.id}', this.value, '${reportType}')"
                            style="padding: 8px 12px; border-radius: 6px; border: 2px solid #ddd; font-size: 14px; cursor: pointer; background: white;"
                        >
                            <option value="${report.status}" selected>${report.status}</option>
                            ${report.status !== 'pending' ? '<option value="pending">pending</option>' : ''}
                            ${report.status !== 'reviewed' ? '<option value="reviewed">reviewed</option>' : ''}
                            ${report.status !== 'dismissed' ? '<option value="dismissed">dismissed</option>' : ''}
                        </select>
                    </div>
                `;
            } else {
                // Profile report
                const reportedUser = report.reported_user;
                const reporter = report.reporter;

                html = `
                    <h2 style="margin-bottom: 20px;">Profile Report Details</h2>

                    <div style="background: #E8F0FF; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #4A90E2;">
                        <h3 style="color: #4A90E2; margin-bottom: 15px;">Report Information</h3>

                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
                            <div>
                                <strong style="color: #333;">Category:</strong>
                                <p style="color: #666; margin-top: 5px;">${report.reason}</p>
                            </div>
                            <div>
                                <strong style="color: #333;">Status:</strong>
                                <p style="margin-top: 5px;">
                                    <span class="badge" style="background: ${report.status === 'pending' ? '#FFA500' : '#4CAF50'}; color: white;">${report.status}</span>
                                </p>
                            </div>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <strong style="color: #333;">Additional Details:</strong>
                            <p style="color: #666; margin-top: 5px; white-space: pre-wrap; background: white; padding: 10px; border-radius: 6px;">${report.details || 'No additional details provided'}</p>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div>
                                <strong style="color: #333;">Reported By:</strong>
                                <p style="margin-top: 5px;">
                                    <span class="clickable-username" onclick="closeReportDetail(); openUserDetail('${report.reported_by}')">@${reporter?.username || 'Unknown'}</span>
                                </p>
                            </div>
                            <div>
                                <strong style="color: #333;">Reported On:</strong>
                                <p style="color: #666; margin-top: 5px;">${new Date(report.created_at).toLocaleString()}</p>
                            </div>
                        </div>
                    </div>

                    <div style="background: #f9f9f9; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h3 style="color: #333; margin-bottom: 15px;">Reported User</h3>

                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                            ${reportedUser?.avatar_url
                                ? `<img src="${reportedUser.avatar_url}" class="avatar" style="width: 60px; height: 60px;">`
                                : `<div class="avatar" style="width: 60px; height: 60px; background: #FF6B9D; color: white; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold;">${reportedUser?.username?.charAt(0).toUpperCase() || '?'}</div>`
                            }
                            <div>
                                <span class="clickable-username" onclick="closeReportDetail(); openUserDetail('${report.reported_user_id}')">@${reportedUser?.username || 'Unknown'}</span>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap;">
                        <button class="btn btn-info" onclick="closeReportDetail(); openUserDetail('${report.reported_by}')">View Reporter Profile</button>
                        <button class="btn btn-info" onclick="closeReportDetail(); openUserDetail('${report.reported_user_id}')">View Reported User Profile</button>
                        <select
                            onchange="updateReportStatusFromDetail('${report.id}', this.value, '${reportType}')"
                            style="padding: 8px 12px; border-radius: 6px; border: 2px solid #ddd; font-size: 14px; cursor: pointer; background: white;"
                        >
                            <option value="${report.status}" selected>${report.status}</option>
                            ${report.status !== 'pending' ? '<option value="pending">pending</option>' : ''}
                            ${report.status !== 'reviewed' ? '<option value="reviewed">reviewed</option>' : ''}
                            ${report.status !== 'dismissed' ? '<option value="dismissed">dismissed</option>' : ''}
                        </select>
                    </div>
                `;
            }

            document.getElementById('reportDetailContent').innerHTML = html;
            document.getElementById('reportDetailModal').classList.add('show');
        }

        function closeReportDetail() {
            document.getElementById('reportDetailModal').classList.remove('show');
        }

        async function deleteBlipFromReport(blipId, username, reportId) {
            if (!confirm(`Delete this blip by ${username}? This CANNOT be undone!`)) return;

            const { error } = await supabaseClient
                .from('blips')
                .delete()
                .eq('id', blipId);

            if (error) {
                alert('Error: ' + error.message);
                return;
            }

            await logAdminAction('delete_blip', null, { blip_id: blipId, report_id: reportId }, `Deleted reported blip by ${username}`);
            alert('Blip deleted successfully');
            closeReportDetail();
            loadReports();
            loadStats();
        }

        async function deleteVideoReplyFromReport(videoReplyId, username, reportId) {
            if (!confirm(`Delete this video reply by ${username}? This CANNOT be undone!`)) return;

            const { error } = await supabaseClient
                .from('video_replies')
                .delete()
                .eq('id', videoReplyId);

            if (error) {
                alert('Error: ' + error.message);
                return;
            }

            await logAdminAction('delete_video_reply', null, { video_reply_id: videoReplyId, report_id: reportId }, `Deleted reported video reply by ${username}`);
            alert('Video reply deleted successfully');
            closeReportDetail();
            loadReports();
            loadStats();
        }

        async function updateReportStatusFromDetail(reportId, status, reportType) {
            await updateReportStatus(reportId, status, reportType);
            closeReportDetail();
        }

        async function loadVerifications() {
            console.log('Loading verifications...');
            const { data: verifications, error } = await supabaseClient
                .from('verification_applications')
                .select(`
                    *,
                    user:users!verification_applications_user_id_fkey(id, username, avatar_url, email, display_name, is_verified)
                `)
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading verifications:', error);
                alert('Error loading verifications: ' + error.message);
                return;
            }

            console.log('Verifications loaded:', verifications);
            allVerifications = verifications || [];
            filterVerifications();
        }

        function setVerificationFilter(filter) {
            currentVerificationFilter = filter;

            // Update button styles
            document.getElementById('filterVerificationsPending').className = filter === 'pending' ? 'btn btn-primary' : 'btn btn-secondary';
            document.getElementById('filterVerificationsApproved').className = filter === 'approved' ? 'btn btn-primary' : 'btn btn-secondary';
            document.getElementById('filterVerificationsRejected').className = filter === 'rejected' ? 'btn btn-primary' : 'btn btn-secondary';
            document.getElementById('filterVerificationsAll').className = filter === 'all' ? 'btn btn-primary' : 'btn btn-secondary';

            filterVerifications();
        }

        function filterVerifications() {
            let filtered = allVerifications.filter(verification => {
                if (currentVerificationFilter === 'all') return true;
                return verification.status === currentVerificationFilter;
            });

            displayVerifications(filtered);
        }

        function displayVerifications(verifications) {
            if (!verifications || verifications.length === 0) {
                document.getElementById('verificationsTable').innerHTML = '<div class="no-results">No verification requests found</div>';
                return;
            }

            const html = `
                <table>
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Email</th>
                            <th>Real Name</th>
                            <th>Status</th>
                            <th>Submitted</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${verifications.map(verification => `
                            <tr>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        ${verification.user?.avatar_url
                                            ? `<img src="${verification.user.avatar_url}" class="avatar">`
                                            : `<div class="avatar" style="background: #FF6B9D; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">${verification.user?.username?.charAt(0).toUpperCase() || '?'}</div>`
                                        }
                                        <div>
                                            <span class="clickable-username" onclick="openUserDetail('${verification.user_id}')">@${verification.user?.username || 'Unknown'}</span>
                                            ${verification.user?.is_verified ? '<br><span class="badge" style="background: #1DA1F2; color: white;">✓ VERIFIED</span>' : ''}
                                        </div>
                                    </div>
                                </td>
                                <td>${verification.user?.email || 'N/A'}</td>
                                <td style="max-width: 200px; white-space: pre-wrap; word-wrap: break-word;">${verification.real_name || 'No name provided'}</td>
                                <td><span class="badge" style="background: ${verification.status === 'pending' ? '#FFA500' : verification.status === 'approved' ? '#4CAF50' : '#FF4444'}; color: white;">${verification.status}</span></td>
                                <td>${new Date(verification.created_at).toLocaleString()}</td>
                                <td>
                                    <button class="btn btn-info" onclick="openVerificationDetail('${verification.id}')">View Details</button>
                                    ${verification.status === 'pending' ? `
                                        <button class="btn btn-success" onclick="approveVerification('${verification.id}', '${verification.user_id}', '${verification.user?.username}')">Approve</button>
                                        <button class="btn btn-danger" onclick="rejectVerification('${verification.id}', '${verification.user?.username}')">Reject</button>
                                    ` : ''}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('verificationsTable').innerHTML = html;
        }

        async function openVerificationDetail(verificationId) {
            const verification = allVerifications.find(v => v.id === verificationId);
            if (!verification) return;

            const html = `
                <h2 style="margin-bottom: 20px;">Verification Application Details</h2>

                <div class="user-detail-header">
                    ${verification.user?.avatar_url
                        ? `<img src="${verification.user.avatar_url}" class="user-detail-avatar">`
                        : `<div class="user-detail-avatar" style="background: white; color: #FF6B9D; display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: bold;">${verification.user?.username?.charAt(0).toUpperCase() || '?'}</div>`
                    }
                    <div class="user-detail-info">
                        <h2>${verification.user?.display_name || verification.user?.username || 'N/A'}</h2>
                        <p>@${verification.user?.username || 'N/A'}</p>
                        <p>${verification.user?.email || 'No email'}</p>
                    </div>
                </div>

                <div class="action-section">
                    <h3>Application Details</h3>
                    <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="margin-bottom: 15px;">
                            <strong style="color: #333;">Status:</strong>
                            <p style="margin-top: 5px;"><span class="badge" style="background: ${verification.status === 'pending' ? '#FFA500' : verification.status === 'approved' ? '#4CAF50' : '#FF4444'}; color: white;">${verification.status.toUpperCase()}</span></p>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong style="color: #333;">Real Name:</strong>
                            <p style="color: #666; margin-top: 5px; white-space: pre-wrap;">${verification.real_name || 'No name provided'}</p>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong style="color: #333;">Submitted:</strong>
                            <p style="color: #666; margin-top: 5px;">${new Date(verification.created_at).toLocaleString()}</p>
                        </div>
                        ${verification.reviewed_at ? `
                            <div style="margin-bottom: 15px;">
                                <strong style="color: #333;">Reviewed:</strong>
                                <p style="color: #666; margin-top: 5px;">${new Date(verification.reviewed_at).toLocaleString()}</p>
                            </div>
                        ` : ''}
                        ${verification.rejection_reason ? `
                            <div style="margin-bottom: 15px;">
                                <strong style="color: #FF4444;">Rejection Reason:</strong>
                                <p style="color: #666; margin-top: 5px; white-space: pre-wrap;">${verification.rejection_reason}</p>
                            </div>
                        ` : ''}
                    </div>
                </div>

                <div class="action-section">
                    <h3>Social Links</h3>
                    <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        ${verification.social_links && verification.social_links.length > 0 ?
                            verification.social_links.map(link => `
                                <div style="margin-bottom: 10px;">
                                    <strong>${link.platform}:</strong> <a href="${link.url}" target="_blank" style="color: #4A90E2;">${link.url}</a>
                                    ${link.follower_count ? ` (${link.follower_count.toLocaleString()} followers)` : ''}
                                </div>
                            `).join('')
                            : '<p style="color: #999;">No social links provided</p>'
                        }
                    </div>
                </div>

                <div class="action-section">
                    <h3>ID Photos</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        ${verification.id_front_url ? `
                            <div>
                                <strong style="display: block; margin-bottom: 10px; color: #333;">ID Front:</strong>
                                <img src="${verification.id_front_url}" style="width: 100%; border-radius: 8px; border: 1px solid #ddd;">
                            </div>
                        ` : ''}
                        ${verification.id_back_url ? `
                            <div>
                                <strong style="display: block; margin-bottom: 10px; color: #333;">ID Back:</strong>
                                <img src="${verification.id_back_url}" style="width: 100%; border-radius: 8px; border: 1px solid #ddd;">
                            </div>
                        ` : ''}
                        ${!verification.id_front_url && !verification.id_back_url ? '<p style="color: #999;">No ID photos provided</p>' : ''}
                    </div>
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="closeVerificationDetail()">Close</button>
                    <button class="btn btn-info" onclick="closeVerificationDetail(); openUserDetail('${verification.user_id}')">View User Profile</button>
                    ${verification.status === 'pending' ? `
                        <button class="btn btn-success" onclick="approveVerification('${verification.id}', '${verification.user_id}', '${verification.user?.username}')">Approve</button>
                        <button class="btn btn-danger" onclick="rejectVerification('${verification.id}', '${verification.user?.username}')">Reject</button>
                    ` : ''}
                </div>
            `;

            document.getElementById('verificationDetailContent').innerHTML = html;
            document.getElementById('verificationDetailModal').classList.add('show');
        }

        function closeVerificationDetail() {
            document.getElementById('verificationDetailModal').classList.remove('show');
        }

        async function approveVerification(verificationId, userId, username) {
            if (!confirm(`Approve verification for @${username}? They will receive a blue checkmark.`)) return;

            // Update user to verified
            const { error: userError } = await supabaseClient
                .from('users')
                .update({ is_verified: true })
                .eq('id', userId);

            if (userError) {
                alert('Error verifying user: ' + userError.message);
                return;
            }

            // Update application status
            const { error: appError } = await supabaseClient
                .from('verification_applications')
                .update({
                    status: 'approved',
                    reviewed_by: currentAdminId,
                    reviewed_at: new Date().toISOString()
                })
                .eq('id', verificationId);

            if (appError) {
                alert('Error updating application: ' + appError.message);
                return;
            }

            // Log the action
            await logAdminAction('verification_approved', userId, { verification_id: verificationId }, `Approved verification for @${username}`);

            alert(`@${username} has been verified!`);
            closeVerificationDetail();
            loadVerifications();
            loadStats();
            loadUsers();
        }

        async function rejectVerification(verificationId, username) {
            const reason = prompt(`Why are you rejecting verification for @${username}?\n\nThis reason will be shown to the user.`);
            if (!reason) return;

            const verification = allVerifications.find(v => v.id === verificationId);

            const { error } = await supabaseClient
                .from('verification_applications')
                .update({
                    status: 'rejected',
                    rejection_reason: reason,
                    reviewed_by: currentAdminId,
                    reviewed_at: new Date().toISOString()
                })
                .eq('id', verificationId);

            if (error) {
                alert('Error: ' + error.message);
                return;
            }

            await logAdminAction('verification_rejected', verification.user_id, { verification_id: verificationId, reason }, `Rejected verification for @${username}: ${reason}`);

            alert(`Verification rejected for @${username}`);
            closeVerificationDetail();
            loadVerifications();
            loadStats();
        }

        // ===== Admin Drops Functions =====

        function initializeDropMap() {
            if (dropMap) return; // Already initialized

            try {
                // Default to San Francisco
                const defaultLocation = { lat: 37.7749, lng: -122.4194 };

                dropMap = new google.maps.Map(document.getElementById('dropMap'), {
                    center: defaultLocation,
                    zoom: 13,
                    mapTypeControl: true,
                    streetViewControl: false,
                    fullscreenControl: true,
                    styles: [
                        {
                            featureType: 'poi',
                            elementType: 'labels',
                            stylers: [{ visibility: 'off' }]
                        }
                    ]
                });

                // Initialize Google Places Autocomplete
                const searchInput = document.getElementById('addressSearch');
                const autocomplete = new google.maps.places.Autocomplete(searchInput);
                autocomplete.bindTo('bounds', dropMap);

                autocomplete.addListener('place_changed', () => {
                    const place = autocomplete.getPlace();
                    if (!place.geometry || !place.geometry.location) return;

                    // Move map to selected location
                    dropMap.setCenter(place.geometry.location);
                    dropMap.setZoom(15);

                    // Place marker
                    if (dropMarker) dropMarker.setMap(null);
                    dropMarker = new google.maps.Marker({
                        position: place.geometry.location,
                        map: dropMap,
                        title: 'Drop Location'
                    });

                    // Update selected location
                    selectedDropLocation = {
                        lat: place.geometry.location.lat(),
                        lng: place.geometry.location.lng()
                    };

                    document.getElementById('dropLocationInfo').innerHTML = `
                        <strong>Location:</strong> ${place.formatted_address || place.name}
                    `;
                });

                // Add click listener to place marker
                dropMap.addListener('click', (event) => {
                    placeDropMarker(event.latLng);
                });

                // Try to get user's current location
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const userLocation = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            dropMap.setCenter(userLocation);
                        },
                        (error) => {
                            console.log('Geolocation error:', error);
                        }
                    );
                }
            } catch (error) {
                console.error('Error initializing map:', error);
                alert('Failed to initialize map. Please refresh the page.');
            }
        }

        function placeDropMarker(location) {
            // Remove existing marker
            if (dropMarker) {
                dropMarker.setMap(null);
            }

            // Create new marker
            dropMarker = new google.maps.Marker({
                position: location,
                map: dropMap,
                animation: google.maps.Animation.DROP,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 10,
                    fillColor: '#FF6B9D',
                    fillOpacity: 1,
                    strokeColor: '#FFA06B',
                    strokeWeight: 3
                }
            });

            // Store selected location
            selectedDropLocation = {
                lat: location.lat(),
                lng: location.lng()
            };

            // Update location info
            document.getElementById('dropLocationInfo').innerHTML = `
                <strong>Location set:</strong> ${selectedDropLocation.lat.toFixed(6)}, ${selectedDropLocation.lng.toFixed(6)}
            `;
        }

        async function createAdminDrop() {
            try {
                // Validate inputs
                const title = document.getElementById('dropTitle').value.trim();
                const description = document.getElementById('dropDescription').value.trim();
                const dropType = document.getElementById('dropType').value;
                const iconType = document.getElementById('dropIconType').value;
                const rewardAmount = parseInt(document.getElementById('dropRewardAmount').value);
                const radius = parseInt(document.getElementById('dropRadius').value);
                const viewLimit = document.getElementById('dropViewLimit').value;
                const expiresAt = document.getElementById('dropExpiresAt').value;
                const notificationMessage = document.getElementById('dropNotificationMessage').value.trim();
                const notificationRadius = parseFloat(document.getElementById('dropNotificationRadius').value);

                if (!title) {
                    alert('Please enter a title');
                    return;
                }

                if (!selectedDropLocation) {
                    alert('Please select a location on the map');
                    return;
                }

                if (!rewardAmount || rewardAmount < 0) {
                    alert('Please enter a valid reward amount');
                    return;
                }

                if (!radius || radius < 1) {
                    alert('Please enter a valid radius');
                    return;
                }

                // Handle media upload if file selected
                const mediaInput = document.getElementById('dropMedia');
                const mediaFile = mediaInput.files[0];
                let mediaUrl = null;
                let mediaType = null;

                if (mediaFile) {
                    const progressDiv = document.getElementById('mediaUploadProgress');
                    progressDiv.style.display = 'block';
                    progressDiv.textContent = 'Uploading media...';

                    const fileExt = mediaFile.name.split('.').pop();
                    const fileName = `admin-drops/${Date.now()}.${fileExt}`;
                    mediaType = mediaFile.type.startsWith('video/') ? 'video' : 'image';

                    const { data: uploadData, error: uploadError } = await supabaseClient.storage
                        .from('blip-videos')
                        .upload(fileName, mediaFile);

                    if (uploadError) {
                        progressDiv.textContent = 'Upload failed: ' + uploadError.message;
                        return;
                    }

                    const { data: { publicUrl } } = supabaseClient.storage
                        .from('blip-videos')
                        .getPublicUrl(fileName);

                    mediaUrl = publicUrl;
                    progressDiv.textContent = 'Media uploaded successfully!';
                    setTimeout(() => { progressDiv.style.display = 'none'; }, 2000);
                }

                // Prepare data
                const dropData = {
                    title: title,
                    description: description || null,
                    latitude: selectedDropLocation.lat,
                    longitude: selectedDropLocation.lng,
                    drop_type: dropType,
                    icon_type: iconType,
                    reward_amount: rewardAmount,
                    radius: radius,
                    view_limit: viewLimit ? parseInt(viewLimit) : null,
                    expires_at: expiresAt ? new Date(expiresAt).toISOString() : null,
                    notification_message: notificationMessage || null,
                    notification_radius_miles: notificationRadius,
                    created_by: currentAdminId,
                    is_active: true,
                    views_count: 0,
                    media_url: mediaUrl,
                    media_type: mediaType
                };

                // Call Edge Function to create drop and send notifications
                const { data: { session } } = await supabaseClient.auth.getSession();
                const response = await fetch('https://obtsdsztblemlbvcrcdy.supabase.co/functions/v1/create-admin-drop', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session?.access_token || SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify(dropData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Error creating drop:', errorData);
                    alert('Failed to create drop: ' + (errorData.error || response.statusText));
                    return;
                }

                const result = await response.json();
                console.log('📦 Drop created successfully:', result);
                console.log('📬 Notifications sent:', result.notificationsSent);
                console.log('📍 Drop ID:', result.drop?.id);

                // Always show notification count (even if 0)
                let successMessage = 'Drop created successfully!';
                const notifCount = result.notificationsSent || 0;

                if (notifCount > 0) {
                    successMessage += `\n\n✅ ${notifCount} notification(s) sent to nearby users.`;
                } else if (notificationMessage) {
                    successMessage += `\n\n⚠️ 0 notifications sent.\nPossible reasons:\n• No users with recent location data (within 4 hours)\n• No users within ${notificationRadius} mile radius\n• Users don't have push tokens`;
                } else {
                    successMessage += `\n\nℹ️ No notification message provided - no notifications sent.`;
                }

                alert(successMessage);

                // Clear form
                document.getElementById('dropTitle').value = '';
                document.getElementById('dropDescription').value = '';
                document.getElementById('dropType').value = 'test';
                document.getElementById('dropIconType').value = 'coin';
                document.getElementById('dropRewardAmount').value = '10';
                document.getElementById('dropRadius').value = '100';
                document.getElementById('dropViewLimit').value = '';
                document.getElementById('dropExpiresAt').value = '';
                document.getElementById('dropNotificationMessage').value = '';
                document.getElementById('dropNotificationRadius').value = '5.0';
                document.getElementById('dropMedia').value = '';

                // Clear marker
                if (dropMarker) {
                    dropMarker.setMap(null);
                    dropMarker = null;
                }
                selectedDropLocation = null;
                document.getElementById('dropLocationInfo').textContent = 'Click on the map to set drop location';

                // Reload drops list
                loadAdminDrops();
            } catch (error) {
                console.error('Error creating admin drop:', error);
                alert('Failed to create drop: ' + error.message);
            }
        }

        async function loadAdminDrops() {
            try {
                const { data, error } = await supabaseClient
                    .from('admin_drops')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('Error loading drops:', error);
                    alert('Failed to load drops: ' + error.message);
                    return;
                }

                allAdminDrops = data || [];
                renderAdminDropsList();
            } catch (error) {
                console.error('Error loading admin drops:', error);
                alert('Failed to load drops: ' + error.message);
            }
        }

        function renderAdminDropsList() {
            const container = document.getElementById('adminDropsList');

            if (allAdminDrops.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <p style="font-size: 18px; margin-bottom: 10px;">No admin drops found</p>
                        <p>Create your first drop using the form above</p>
                    </div>
                `;
                return;
            }

            let html = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #FF6B9D 0%, #FFA06B 100%); color: #000;">
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #E0E0E0;">Title</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #E0E0E0;">Location</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #E0E0E0;">Type</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #E0E0E0;">Reward</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #E0E0E0;">Views</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #E0E0E0;">Status</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #E0E0E0;">Expires</th>
                                <th style="padding: 12px; text-align: center; border-bottom: 2px solid #E0E0E0;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            allAdminDrops.forEach((drop, index) => {
                const isExpired = drop.expires_at && new Date(drop.expires_at) < new Date();
                const isViewLimitReached = drop.view_limit && drop.views_count >= drop.view_limit;
                const statusColor = drop.is_active && !isExpired && !isViewLimitReached ? '#4CAF50' : '#999';
                const statusText = drop.is_active ? (isExpired ? 'Expired' : isViewLimitReached ? 'Limit Reached' : 'Active') : 'Inactive';

                html += `
                    <tr style="border-bottom: 1px solid #E0E0E0;">
                        <td style="padding: 12px;">
                            <strong>${drop.title}</strong>
                            ${drop.description ? `<br><span style="font-size: 12px; color: #333;">${drop.description.substring(0, 50)}${drop.description.length > 50 ? '...' : ''}</span>` : ''}
                        </td>
                        <td style="padding: 12px; font-size: 12px; color: #333;">
                            ${drop.latitude.toFixed(4)}, ${drop.longitude.toFixed(4)}
                            <br>Radius: ${drop.radius}m
                        </td>
                        <td style="padding: 12px;">
                            <span style="background: #E3F2FD; color: #1976D2; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                ${drop.drop_type}
                            </span>
                            <br>
                            <span style="background: #FFF3E0; color: #E65100; padding: 4px 8px; border-radius: 4px; font-size: 12px; margin-top: 4px; display: inline-block;">
                                ${drop.icon_type}
                            </span>
                        </td>
                        <td style="padding: 12px; font-weight: 600; color: #FF6B9D;">
                            ${drop.reward_amount}
                        </td>
                        <td style="padding: 12px;">
                            ${drop.views_count || 0}${drop.view_limit ? ` / ${drop.view_limit}` : ''}
                        </td>
                        <td style="padding: 12px;">
                            <span style="color: ${statusColor}; font-weight: 600;">
                                ${statusText}
                            </span>
                        </td>
                        <td style="padding: 12px; font-size: 12px; color: #333;">
                            ${drop.expires_at ? new Date(drop.expires_at).toLocaleString() : 'Never'}
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                                <button
                                    class="btn btn-info"
                                    onclick="toggleViewerDetails('${drop.id}', ${index})"
                                    style="padding: 6px 12px; font-size: 12px;">
                                    View Details
                                </button>
                                <button
                                    class="btn ${drop.is_active ? 'btn-warning' : 'btn-success'}"
                                    onclick="toggleDropActive('${drop.id}', ${!drop.is_active})"
                                    style="padding: 6px 12px; font-size: 12px;">
                                    ${drop.is_active ? 'Deactivate' : 'Activate'}
                                </button>
                                <button
                                    class="btn btn-danger"
                                    onclick="deleteAdminDrop('${drop.id}')"
                                    style="padding: 6px 12px; font-size: 12px;">
                                    Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                    <!-- Viewer Details Row (Hidden by default) -->
                    <tr id="viewers-${drop.id}" style="display: none;">
                        <td colspan="8" style="padding: 20px; background: #f9f9f9; border-bottom: 2px solid #E0E0E0;">
                            <div id="viewers-content-${drop.id}">
                                <div style="text-align: center; color: #999;">
                                    Loading viewer data...
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = html;

            // Also update markers on the map
            updateDropMarkersOnMap();
        }

        function updateDropMarkersOnMap() {
            if (!dropMap) return;

            // Clear existing drop markers
            dropMapMarkers.forEach(marker => marker.setMap(null));
            dropMapMarkers = [];

            // Add markers for all drops
            allAdminDrops.forEach(drop => {
                const isExpired = drop.expires_at && new Date(drop.expires_at) < new Date();
                const isViewLimitReached = drop.view_limit && drop.views_count >= drop.view_limit;
                const isActive = drop.is_active && !isExpired && !isViewLimitReached;

                // Color based on drop type
                const markerColor = drop.drop_type === 'reward' ? '#FFD700' :
                                   drop.drop_type === 'special' ? '#FF1493' : '#00D4FF';

                // Create marker with custom icon
                const marker = new google.maps.Marker({
                    position: { lat: drop.latitude, lng: drop.longitude },
                    map: dropMap,
                    title: drop.title,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 10,
                        fillColor: markerColor,
                        fillOpacity: isActive ? 0.9 : 0.4,
                        strokeColor: '#ffffff',
                        strokeWeight: 2,
                    },
                });

                // Add click listener to show info
                marker.addListener('click', () => {
                    const infoContent = `
                        <div style="padding: 10px; max-width: 250px;">
                            <h3 style="margin: 0 0 10px 0; color: #333;">${drop.title}</h3>
                            <p style="margin: 5px 0; color: #666;">${drop.description || 'No description'}</p>
                            <p style="margin: 5px 0; font-size: 12px; color: #999;">
                                Type: ${drop.drop_type} | Icon: ${drop.icon_type}<br>
                                Reward: ${drop.reward_amount}<br>
                                Views: ${drop.views_count || 0}${drop.view_limit ? ` / ${drop.view_limit}` : ''}<br>
                                Status: ${isActive ? 'Active' : 'Inactive/Expired'}<br>
                                Expires: ${drop.expires_at ? new Date(drop.expires_at).toLocaleString() : 'Never'}
                            </p>
                            <div style="margin-top: 10px;">
                                <button onclick="toggleDropActive('${drop.id}', ${!drop.is_active}); google.maps.event.trigger(dropMap, 'click');"
                                    style="padding: 6px 12px; margin-right: 5px; background: ${drop.is_active ? '#ff9800' : '#4CAF50'}; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    ${drop.is_active ? 'Deactivate' : 'Activate'}
                                </button>
                                <button onclick="deleteAdminDrop('${drop.id}'); google.maps.event.trigger(dropMap, 'click');"
                                    style="padding: 6px 12px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    Delete
                                </button>
                            </div>
                        </div>
                    `;

                    const infoWindow = new google.maps.InfoWindow({
                        content: infoContent
                    });

                    infoWindow.open(dropMap, marker);
                });

                dropMapMarkers.push(marker);
            });

            // Fit bounds to show all markers
            if (dropMapMarkers.length > 0) {
                const bounds = new google.maps.LatLngBounds();
                dropMapMarkers.forEach(marker => bounds.extend(marker.getPosition()));
                dropMap.fitBounds(bounds);
            }
        }

        async function toggleDropActive(dropId, isActive) {
            try {
                const { error } = await supabaseClient
                    .from('admin_drops')
                    .update({ is_active: isActive })
                    .eq('id', dropId);

                if (error) {
                    console.error('Error toggling drop status:', error);
                    alert('Failed to toggle drop status: ' + error.message);
                    return;
                }

                alert(`Drop ${isActive ? 'activated' : 'deactivated'} successfully!`);
                loadAdminDrops();
            } catch (error) {
                console.error('Error toggling drop status:', error);
                alert('Failed to toggle drop status: ' + error.message);
            }
        }

        async function deleteAdminDrop(dropId) {
            if (!confirm('Are you sure you want to delete this drop? This action cannot be undone.')) {
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('admin_drops')
                    .delete()
                    .eq('id', dropId);

                if (error) {
                    console.error('Error deleting drop:', error);
                    alert('Failed to delete drop: ' + error.message);
                    return;
                }

                alert('Drop deleted successfully!');
                loadAdminDrops();
            } catch (error) {
                console.error('Error deleting drop:', error);
                alert('Failed to delete drop: ' + error.message);
            }
        }

        async function toggleViewerDetails(dropId, index) {
            const viewerRow = document.getElementById(`viewers-${dropId}`);

            if (viewerRow.style.display === 'none') {
                // Show the row and load viewer data
                viewerRow.style.display = 'table-row';
                await loadViewerData(dropId);
            } else {
                // Hide the row
                viewerRow.style.display = 'none';
            }
        }

        async function loadViewerData(dropId) {
            const contentDiv = document.getElementById(`viewers-content-${dropId}`);

            try {
                // Fetch viewer data with user information
                const { data: views, error } = await supabaseClient
                    .from('admin_drop_views')
                    .select(`
                        *,
                        viewer:users!admin_drop_views_viewer_id_fkey(id, username, email, avatar_url)
                    `)
                    .eq('admin_drop_id', dropId)
                    .order('viewed_at', { ascending: false });

                if (error) {
                    console.error('Error loading viewer data:', error);
                    contentDiv.innerHTML = `
                        <div style="text-align: center; color: #f44336;">
                            Failed to load viewer data: ${error.message}
                        </div>
                    `;
                    return;
                }

                if (!views || views.length === 0) {
                    contentDiv.innerHTML = `
                        <div style="text-align: center; color: #999; padding: 20px;">
                            <p style="font-size: 16px; margin-bottom: 10px;">No viewers yet</p>
                            <p style="font-size: 14px;">This drop has not been viewed by any users</p>
                        </div>
                    `;
                    return;
                }

                // Display viewer data in a nice table
                let html = `
                    <div style="margin-bottom: 15px;">
                        <h4 style="color: #333; margin-bottom: 15px;">
                            👁️ Viewer Analytics (${views.length} total ${views.length === 1 ? 'view' : 'views'})
                        </h4>
                    </div>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden;">
                            <thead>
                                <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                    <th style="padding: 12px; text-align: left;">#</th>
                                    <th style="padding: 12px; text-align: left;">User</th>
                                    <th style="padding: 12px; text-align: left;">Email</th>
                                    <th style="padding: 12px; text-align: left;">Viewed At</th>
                                    <th style="padding: 12px; text-align: left;">Time Ago</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                views.forEach((view, idx) => {
                    const viewedDate = new Date(view.viewed_at);
                    const timeAgo = getTimeAgo(viewedDate);
                    const viewer = view.viewer || {};

                    html += `
                        <tr style="border-bottom: 1px solid #E0E0E0;">
                            <td style="padding: 12px; color: #666;">${idx + 1}</td>
                            <td style="padding: 12px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    ${viewer.avatar_url
                                        ? `<img src="${viewer.avatar_url}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">`
                                        : `<div style="width: 32px; height: 32px; border-radius: 50%; background: #FF6B9D; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">${viewer.username?.charAt(0).toUpperCase() || '?'}</div>`
                                    }
                                    <strong style="color: #333;">@${viewer.username || 'Unknown'}</strong>
                                </div>
                            </td>
                            <td style="padding: 12px; color: #666; font-size: 13px;">${viewer.email || 'N/A'}</td>
                            <td style="padding: 12px; color: #666; font-size: 13px;">
                                ${viewedDate.toLocaleString()}
                            </td>
                            <td style="padding: 12px; color: #999; font-size: 13px; font-style: italic;">
                                ${timeAgo}
                            </td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;

                contentDiv.innerHTML = html;
            } catch (error) {
                console.error('Error loading viewer data:', error);
                contentDiv.innerHTML = `
                    <div style="text-align: center; color: #f44336;">
                        Failed to load viewer data: ${error.message}
                    </div>
                `;
            }
        }

        function getTimeAgo(date) {
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);

            if (seconds < 60) return 'just now';

            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes} minute${minutes !== 1 ? 's' : ''} ago`;

            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours} hour${hours !== 1 ? 's' : ''} ago`;

            const days = Math.floor(hours / 24);
            if (days < 7) return `${days} day${days !== 1 ? 's' : ''} ago`;

            const weeks = Math.floor(days / 7);
            if (weeks < 4) return `${weeks} week${weeks !== 1 ? 's' : ''} ago`;

            const months = Math.floor(days / 30);
            if (months < 12) return `${months} month${months !== 1 ? 's' : ''} ago`;

            const years = Math.floor(days / 365);
            return `${years} year${years !== 1 ? 's' : ''} ago`;
        }

        // ===== End Admin Drops Functions =====

        function showTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tab + '-tab').classList.add('active');

            // Initialize map when admin drops tab is shown
            if (tab === 'admin-drops') {
                setTimeout(() => {
                    initializeDropMap();
                    loadAdminDrops();
                }, 100);
            }
        }

        // Emoji picker functions
        function openEmojiPicker() {
            const picker = document.getElementById('emojiPicker');
            picker.style.display = picker.style.display === 'none' ? 'block' : 'none';
        }

        function insertEmoji(emoji) {
            const textarea = document.getElementById('dropNotificationMessage');
            const cursorPos = textarea.selectionStart;
            const textBefore = textarea.value.substring(0, cursorPos);
            const textAfter = textarea.value.substring(cursorPos);
            textarea.value = textBefore + emoji + textAfter;
            textarea.selectionStart = cursorPos + emoji.length;
            textarea.selectionEnd = cursorPos + emoji.length;
            textarea.focus();

            // Close picker
            document.getElementById('emojiPicker').style.display = 'none';
        }

        // Close emoji picker when clicking outside
        document.addEventListener('click', function(event) {
            const picker = document.getElementById('emojiPicker');
            const emojiButton = event.target.closest('button[onclick="openEmojiPicker()"]');
            const emojiPickerButton = event.target.closest('button[onclick^="insertEmoji"]');

            if (!emojiButton && !emojiPickerButton && picker && !picker.contains(event.target)) {
                picker.style.display = 'none';
            }
        });

        // Check if already logged in
        supabaseClient.auth.getSession().then(({ data: { session } }) => {
            if (session) {
                currentAdminId = session.user.id;
                document.getElementById('app').className = 'logged-in';
                loadDashboard();
            }
        });
    </script>
</body>
</html>
